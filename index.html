<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title> To-Do List</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
  body {
      margin: 0;
      padding: 0;
      font-family: 'Baloo 2', cursive;
      min-height: 100vh;
      overflow-y: auto;
      background: linear-gradient(135deg, #0f3dc8 , #04edce);
      transition: background 0.5s linear;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
      opacity: 0.2;
      z-index: 0;
    }
    .hamburger {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 30px;
      height: 25px;
      cursor: pointer;
      z-index: 10;
    }
    .hamburger div {
      background-color: white;
      height: 4px;
      margin: 5px 0;
      border-radius: 2px;
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100%;
      /* Glassmorphism effect for transparency */
      background: rgba(7, 116, 218, 0.22);
      box-shadow: 2px 0 10px rgba(0,0,0,0.07);
      padding: 20px 20px 18px 20px;
      z-index: 9;
      transition: 0.3s;
      display: flex;
      flex-direction: column;
      gap: 10px;
      backdrop-filter: blur(17px) saturate(140%);
      border-right: 1.5px solid rgba(64,137,255,0.17);
    }
    .sidebar.open {
      left: 0;
    }
    .project-search-bar {
      padding: 8px 15px;
      border-radius: 20px;
      border: 1.5px solid #ff9a8b;
      outline: none;
      font-size: 1em;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
      background: rgba(255,255,255,0.7);
    }
    .project-item {
      padding: 10px 10px 10px 0;
      background: #f0f0f0b8;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      position: relative;
      box-shadow: 0 1px 5px #0001;
      transition: background 0.22s;
    }
    .project-item input {
      border: none;
      background: transparent;
      font-family: 'Baloo 2';
      font-size: 1em;
      width: 80%;
      outline: none;
      cursor: pointer;
      color: #185a9d;
    }
    .delete-btn-project {
      background: #ff4d4d;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
    }

    /* Three dots menu */
    .project-menu-container {
      position: relative;
      margin-left: 5px;
    }
    .project-menu-trigger {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.3em;
      color: #333;
      padding: 0 7px;
    }
    .project-menu {
      display: none;
      position: absolute;
      top: 25px;
      right: 0;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      border-radius: 8px;
      z-index: 20;
      min-width: 130px;
      flex-direction: column;
      animation: fadeIn 0.2s;
    }
    .project-menu.show {
      display: flex;
    }
    .project-menu button {
      background: none;
      border: none;
      color: #333;
      padding: 12px 18px;
      text-align: left;
      cursor: pointer;
      font-size: 1em;
      width: 100%;
      border-radius: 8px;
      transition: background 0.15s;
    }
    .project-menu button:hover {
      background: #ececec;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .add-project-btn {
      background: linear-gradient(90deg, #43cea2 0%, #185a9d 90%);
      color: white;
      padding: 14px 0;
      border: none;
      border-radius: 24px;
      font-size: 1.15em;
      font-weight: 800;
      box-shadow: 0 2px 16px #185a9d33;
      margin-bottom: 16px;
      transition: background 0.22s, transform 0.13s, box-shadow 0.15s;
      width: 100%;
      letter-spacing: 1.1px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      outline: none;
      position: relative;
      overflow: hidden;
    }
    .add-project-btn::before {
      content: "";
      background: linear-gradient(90deg,#ff9966,#ff5e62);
      position: absolute;
      left: -50%;
      top: 0;
      width: 200%;
      height: 100%;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 0;
    }
    .add-project-btn:active {
      transform: scale(0.97);
    }
    .add-project-btn:hover::before {
      opacity: 0.18;
    }
    .add-project-btn:hover {
      background: linear-gradient(90deg, #185a9d 0%, #43cea2 90%);
      box-shadow: 0 4px 24px #43cea255;
      color: #fff;
    }
    .add-project-btn i {
      font-size: 1.25em;
      margin-right: 2px;
    }
    /* Container becomes glass-morphism */
    .container {
      margin: 60px auto;
      background: rgba(255,255,255,0.5);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 40px;
      width: 90%;
      max-width: 600px;
      text-align: center;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(9px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.25);
      transition: background 0.4s;
    }
    .container:hover {
      background: rgba(255,255,255,0.65);
    }
    h1 {
      margin-bottom: 10px;
      color: #ff6f61;
      font-size: 2.5em;
      letter-spacing: 1px;
      text-shadow: 0 2px 10px #fff8;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    .emoji-fire {
      font-size: 1.2em;
      animation: firePulse 1.2s infinite alternate;
    }
    @keyframes firePulse {
      0% { filter: drop-shadow(0 0 6px #ff6f61); }
      100% { filter: drop-shadow(0 0 17px #ffb100); }
    }
    .quote {
      font-size: 1.1em;
      color: #555;
      margin-bottom: 20px;
      font-style: italic;
      min-height: 32px;
      transition: color 0.3s;
    }
    .quote:hover {
      color: #0f3dc8;
      cursor: pointer;
    }
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      background: rgba(240, 248, 255, 0.35);
      padding: 16px;
      border-radius: 18px;
      box-shadow: 0 2px 8px #0001;
      transition: background 0.4s;
    }
    .input-row input[type="text"], .input-row input[type="date"], .input-row select {
      padding: 10px 15px;
      border-radius: 30px;
      border: 2px solid #ff9a8b;
      outline: none;
      font-size: 1em;
      background: #fff9;
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    .input-row input[type="text"]:focus, .input-row input[type="date"]:focus, .input-row select:focus {
      box-shadow: 0 0 7px #ff6f61a8;
      border-color: #0f3dc8;
    }
    .input-row button {
      background: linear-gradient(90deg, #ff6f61, #ff9a8b);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      font-size: 1em;
      cursor: pointer;
      transition: 0.3s;
      font-weight: bold;
      letter-spacing: 1px;
      box-shadow: 0 1px 5px #ff9a8b80;
    }
    .input-row button:hover {
      background: linear-gradient(90deg, #e94e3e, #ffb88c);
      transform: scale(1.05);
    }
    ul {
      list-style: none;
      padding: 0;
      margin-top: 20px;
    }
    li {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
      color: #333;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 15px;
      font-size: 1.1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: 0.3s;
      flex-wrap: wrap;
      gap: 10px;
      position: relative;
      cursor: pointer;
      animation: fadeInList 0.4s;
    }
    li.completed {
      text-decoration: line-through;
      opacity: 0.6;
      background: linear-gradient(135deg,#d9e7ff 0%,#b5b0ff 100%);
    }
    @keyframes fadeInList {
      from { opacity: 0; transform: translateY(20px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .delete-btn {
      background: #ff4d4d;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      margin-left: 8px;
      transition: background 0.2s, transform 0.2s;
    }
    .delete-btn:hover {
      background: #c0392b;
      transform: scale(1.12);
    }
    .priority-label {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 20px;
      color: white;
    }
    .priority-1 { background-color: #e74c3c; }
    .priority-2 { background-color: #e67e22; }
    .priority-3 { background-color: #3498db; }
    .priority-4 { background-color: #2ecc71; }
    .task-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 5px;
      min-width: 160px;
    }
    .checkbox {
      margin-right: 10px;
      accent-color: #ff9a8b;
      transform: scale(1.25);
    }
    .tag-chip {
      display: inline-block;
      background: #fff3ba;
      color: #8c6d1f;
      border-radius: 20px;
      padding: 2px 10px;
      font-size: 0.95em;
      margin-right: 8px;
    }
  
    
    /* theme toggle button */
    .theme-toggle {
      position: absolute;
      top: 24px;
      right: 28px;
      background: #fff4;
      border: none;
      border-radius: 50%;
      width: 37px;
      height: 37px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.45em;
      cursor: pointer;
      z-index: 12;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 6px #0002;
    }
    .theme-toggle:hover {
      background: #ff9a8b;
      color: #fff;
    }
    /* Progress bar */
    .progress-bar-container {
      margin: 15px 0 0 0;
      width: 100%;
      background: #ececec;
      border-radius: 12px;
      height: 18px;
      overflow: hidden;
      box-shadow: 0 1px 4px #0001;
      position: relative;
    }
    .progress-bar-fill {
      height: 100%;
      transition: width 0.6s;
      background: linear-gradient(90deg,#43cea2,#185a9d);
      border-radius: 12px 0 0 12px;
      font-size: 0.9em;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      font-weight: bold;
      letter-spacing: 1px;
      padding-left: 12px;
      position: absolute;
      left: 0; top: 0;
      min-width: 80px;
      /* 0% text always visible */
      z-index: 1;
    }
    .progress-bar-label {
      position: absolute;
      left: 12px;
      top: 0;
      height: 100%;
      display: flex;
      align-items: center;
      color: #333;
      font-weight: bold;
      font-size: 0.97em;
      letter-spacing: 0.5px;
      z-index: 2;
      pointer-events: none;
      user-select: none;
      mix-blend-mode: difference;
    }
    /* For small width, label stays visible */
    .progress-bar-fill:empty + .progress-bar-label {
      color: #333;
    }
    /* Reminder icon for due tasks */
    .reminder-icon {
      color: #e74c3c;
      margin-left: 8px;
      font-size: 1.2em;
      animation: pulseRemind 1s infinite alternate;
    }
    @keyframes pulseRemind {
      0% { filter: drop-shadow(0 0 0px #e74c3c);}
      100% { filter: drop-shadow(0 0 6px #e74c3c);}
    }
    /* Task notes popup */
    .notes-popup {
      display: none;
      position: absolute;
      left: 60%;
      top: 45px;
      background: #fffbe8;
      color: #333;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 3px 12px #0002;
      min-width: 190px;
      z-index: 50;
      font-size: 1em;
    }
    .notes-popup.show {
      display: block;
      animation: fadeIn 0.17s;
    }
    .notes-btn {
      background: #ffe066;
      border: none;
      border-radius: 14px;
      color: #856404;
      font-size: 1.1em;
      margin-left: 10px;
      padding: 5px 12px;
      cursor: pointer;
      transition: background 0.18s;
    }
    .notes-btn:hover {
      background: #ffef9f;
    }
    /* Undo bar */
    .undo-bar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff5b8;
      color: #333;
      border-radius: 12px;
      padding: 13px 28px;
      box-shadow: 0 3px 12px #0002;
      font-size: 1.1em;
      display: none;
      align-items: center;
      gap: 15px;
      z-index: 120;
      animation: fadeIn 0.3s;
      font-family: inherit;
    }
    .undo-bar.show {
      display: flex;
    }
    .undo-btn {
      background: #ff9a8b;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 18px;
      font-size: 1em;
      cursor: pointer;
      font-weight: bold;
      margin-left: 8px;
      transition: background 0.2s;
    }
    .undo-btn:hover {
      background: #0f3dc8;
    }
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 7px;
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #ff9a8b;
      border-radius: 5px;
    }
    ::selection {
      background: #ffbeaa;
    }
  </style>
</head>
<body>
 <button class="calendar-btn" onclick="window.location.href='calendar.html'"
  style="position:absolute;top:24px;left:80px;background:linear-gradient(90deg,#43cea2,#185a9d);color:#fff;border:none;border-radius:20px;padding:10px 25px;font-size:1.08em;font-weight:700;box-shadow:0 2px 12px #185a9d22;cursor:pointer;z-index:15;transition:background 0.16s;">
  <i class="fa fa-calendar"></i> Calendar
</button>
<button class="analytics-btn" onclick="window.location.href='analytics.html'"
  style="position:absolute;top:24px;left:260px;background:linear-gradient(90deg,#ff9966,#ff5e62);color:#fff;border:none;border-radius:20px;padding:10px 25px;font-size:1.08em;font-weight:700;box-shadow:0 2px 12px #ff996622;cursor:pointer;z-index:15;transition:background 0.16s;">
  <i class="fa fa-chart-line"></i> Analytics
</button>
  <button class="theme-toggle" id="themeToggle" title="Toggle dark/light mode"><i class="fas fa-moon"></i></button>
  <div class="hamburger" onclick="toggleSidebar()">
    <div></div>
    <div></div>
    <div></div>
  </div>
  <div class="sidebar" id="sidebar">
    <input type="text" id="projectSearchBar" class="project-search-bar" placeholder="Search projects...">
    <button class="add-project-btn" onclick="addProject()">
      <i class="fa fa-plus-circle"></i>
      Add Project
    </button>
    <div id="projectList"></div>
  </div>
  <div class="container">
    <h1>
      To-Do List
      <span id="projectTitle" style="font-size:0.65em; margin-left:12px; color:#0f3dc8; background:#fff3; padding:4px 14px; border-radius:10px;"></span>
    </h1>
    <div class="quote" id="quoteBox" title="Click for another quote!">"Loading inspiration..."</div>
    <div class="input-row">
      <input type="text" id="todoInput" placeholder="What do you need to do?">
      <input type="text" id="descInput" placeholder="Description">
      <input type="text" id="tagsInput" placeholder="Tags">
      <select id="categoryInput">
        <option value="General">General</option>
        <option value="Work">Work</option>
        <option value="School">School</option>
        <option value="Personal">Personal</option>
      </select>
      <select id="priorityInput">
        <option value="1">Priority 1 ‚ö†Ô∏è</option>
        <option value="2">Priority 2 ‚ùó</option>
        <option value="3">Priority 3 ‚ùÑÔ∏è</option>
        <option value="4">Priority 4 üí§</option>
      </select>
      <input type="date" id="dateInput">
      <button onclick="addTodo()">Add</button>
    </div>
    <div class="progress-bar-container" style="position: relative;">
      <div class="progress-bar-fill" id="progressBarFill"></div>
      <span class="progress-bar-label" id="progressBarLabel">0% Complete</span>
    </div>
    <ul id="todoList"></ul>
    <ul id="completedList"></ul>
  </div>
  <div class="undo-bar" id="undoBar">
    <span id="undoMsg"></span>
    <button class="undo-btn" onclick="undoDelete()">Undo</button>
  </div>
  <script>
    // --- Animated Gradient Background START ---
    const gradientSets = [
      ['#0f3dc8', '#04edce'],
      ['#f857a6', '#ff5858'],
      ['#43cea2', '#185a9d'],
      ['#ff9966', '#ff5e62'],
      ['#36d1c4', '#b06ab3'],
      ['#e65c00', '#F9D423'],
      ['#fc5c7d', '#6a82fb'],
      ['#ff512f', '#dd2476'],
      ['#1d976c', '#93f9b9'],
      ['#a1c4fd', '#c2e9fb'],
      ['#ee9ca7', '#ffdde1'],
      ['#f6d365', '#fda085'],
      ['#f7971e', '#ffd200']
    ];
    let gradIdx = 0, gradNext = 1, gradStep = 0, gradSpeed = 0.008;
    function lerpColor(a, b, t) {
      const ah = a.replace('#', ''), bh = b.replace('#', '');
      const ar = parseInt(ah.substring(0,2),16), ag = parseInt(ah.substring(2,4),16), ab = parseInt(ah.substring(4,6),16);
      const br = parseInt(bh.substring(0,2),16), bg = parseInt(bh.substring(2,4),16), bb = parseInt(bh.substring(4,6),16);
      const rr = Math.round(ar + (br-ar)*t), rg = Math.round(ag + (bg-ag)*t), rb = Math.round(ab + (bb-ab)*t);
      return `rgb(${rr},${rg},${rb})`;
    }
    function animateGradient() {
      gradStep += gradSpeed;
      if (gradStep >= 1) {
        gradStep = 0;
        gradIdx = gradNext;
        gradNext = (gradNext + 1) % gradientSets.length;
      }
      const [a1, a2] = gradientSets[gradIdx], [b1, b2] = gradientSets[gradNext];
      const color1 = lerpColor(a1, b1, gradStep), color2 = lerpColor(a2, b2, gradStep);
      document.body.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
      requestAnimationFrame(animateGradient);
    }
    animateGradient();
    // --- Animated Gradient Background END ---

    let currentProject = "Default";
    const savedProjects = JSON.parse(localStorage.getItem("projects") || "{}");
    const projects = savedProjects;
    if (!projects[currentProject]) projects[currentProject] = { todos: [], completed: [] };
    const todoList = document.getElementById('todoList'),
          completedList = document.getElementById('completedList'),
          projectList = document.getElementById('projectList'),
          quoteBox = document.getElementById('quoteBox'),
          projectSearchBar = document.getElementById('projectSearchBar'),
          projectTitle = document.getElementById('projectTitle'),
          progressBarFill = document.getElementById('progressBarFill'),
          progressBarLabel = document.getElementById('progressBarLabel'),
          undoBar = document.getElementById('undoBar'),
          undoMsg = document.getElementById('undoMsg');
    let lastDeleted = null, lastDeletedFrom = null;

    const quotes = [
      "‚ÄúThe secret of getting ahead is getting started.‚Äù ‚Äì Mark Twain",
      "‚ÄúIt always seems impossible until it‚Äôs done.‚Äù ‚Äì Nelson Mandela",
      "‚ÄúDon‚Äôt watch the clock; do what it does. Keep going.‚Äù ‚Äì Sam Levenson",
      "‚ÄúStart where you are. Use what you have. Do what you can.‚Äù ‚Äì Arthur Ashe",
      "‚ÄúYou don‚Äôt have to be great to start, but you have to start to be great.‚Äù ‚Äì Zig Ziglar",
      "‚ÄúBelieve you can and you're halfway there.‚Äù - Theodore Roosevelt",
      "‚ÄùThe only person you are destined to become is the person you decide to be.‚Äù ‚Äî Ralph Waldo Emerson",
      "‚ÄùThe question isn't who is going to let me; it's who is going to stop me.‚Äù ‚Äî Ayn Rand",
      "‚ÄùWinning is not a sometime thing; it's an all the time thing.‚Äù ‚Äî Vince Lombardi",
      "‚ÄùBelieve in yourself and all that you are. Know that there is something inside you that is greater than any obstacle.‚Äù ‚Äî Christian D. Larson",
      "‚ÄúYou are never too old to set another goal or to dream a new dream.‚Äù ‚Äì C.S. Lewis",
      "‚ÄúSuccess is not final, failure is not fatal: it is the courage to continue that counts.‚Äù ‚Äì Winston Churchill",
      "‚ÄúAct as if what you do makes a difference. It does.‚Äù ‚Äì William James"
    ];
    function showRandomQuote() {
      const randomIndex = Math.floor(Math.random() * quotes.length);
      quoteBox.textContent = quotes[randomIndex];
    }
    quoteBox.onclick = showRandomQuote;

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }
    document.addEventListener('click', function(e) {
      // Hide all project menus if click is outside
      document.querySelectorAll('.project-menu').forEach(menu => menu.classList.remove('show'));
    });

    function addProject() {
      const name = prompt("Enter new project name:");
      if (!name) return;
      if (!projects[name]) projects[name] = { todos: [], completed: [] };
      currentProject = name;
      saveProjects();
      renderProjectList();
      renderTodos();
    }
    function duplicateProject(name) {
      let newName = name + " Copy";
      let idx = 1;
      while (projects[newName]) { idx++; newName = name + " Copy " + idx; }
      projects[newName] = JSON.parse(JSON.stringify(projects[name]));
      saveProjects();
      renderProjectList();
    }
    function deleteProject(name) {
      if (confirm(`Are you sure you want to delete the project "${name}"?`)) {
        delete projects[name];
        if (currentProject === name) currentProject = "Default";
        saveProjects();
        renderProjectList();
        renderTodos();
      }
    }
    function switchProject(name) {
      currentProject = name;
      renderTodos();
      renderProjectList();
    }
    function renderProjectList(filter = "") {
      projectList.innerHTML = "";
      let projectNames = Object.keys(projects);
      if (filter) {
        const filterLower = filter.toLowerCase();
        projectNames = projectNames.filter(name => name.toLowerCase().includes(filterLower));
      }
      projectNames.forEach(name => {
        const div = document.createElement('div');
        div.className = 'project-item';
        if (name === currentProject) div.style.background = "#cce3ffcc";
        const input = document.createElement('input');
        input.value = name;
        input.spellcheck = false;
        input.style.cursor = 'pointer';
        input.readOnly = true;
        input.addEventListener('click', () => switchProject(name));

        // Project task count badge
        const countBadge = document.createElement('span');
        const count = (projects[name].todos?.length || 0) + (projects[name].completed?.length || 0);
        countBadge.textContent = count;
        countBadge.style.cssText = `
          background: #185a9dcc;
          color: #fff;
          border-radius: 11px;
          font-size: 0.93em;
          padding: 2px 10px;
          margin-left: 5px;
          font-weight: 700;
          letter-spacing: 0.3px;
        `;

        // Three-dot menu
        const menuCont = document.createElement('div');
        menuCont.className = 'project-menu-container';
        const menuTrigger = document.createElement('button');
        menuTrigger.className = 'project-menu-trigger';
        menuTrigger.innerHTML = '<i class="fas fa-ellipsis-v"></i>';
        menuTrigger.onclick = function(e) {
          e.stopPropagation();
          const menu = this.nextSibling;
          document.querySelectorAll('.project-menu').forEach(m => m.classList.remove('show'));
          menu.classList.toggle('show');
        };
        const menu = document.createElement('div');
        menu.className = 'project-menu';
        // Duplicate Project button
        const duplicateBtn = document.createElement('button');
        duplicateBtn.innerHTML = '<i class="fa fa-clone"></i> Duplicate Project';
        duplicateBtn.onclick = (e) => { e.stopPropagation(); duplicateProject(name); menu.classList.remove('show');};
        // Delete Project button
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fa fa-trash"></i> Delete Project';
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteProject(name); menu.classList.remove('show');};
        menu.appendChild(duplicateBtn);
        if(name !== "Default") menu.appendChild(deleteBtn);
        menuCont.appendChild(menuTrigger);
        menuCont.appendChild(menu);
        div.appendChild(input);
        div.appendChild(countBadge);
        div.appendChild(menuCont);
        projectList.appendChild(div);
      });
      projectTitle.textContent = currentProject;
    }
    projectSearchBar.addEventListener('input', function () {
      renderProjectList(this.value);
    });

    function saveProjects() {
      localStorage.setItem("projects", JSON.stringify(projects));
    }
    function renderTodos() {
      todoList.innerHTML = ""; completedList.innerHTML = "";
      const { todos, completed } = projects[currentProject];
      [...todos, ...completed].forEach(data => {
        const li = createTodoElement(data);
        (data.done ? completedList : todoList).appendChild(li);
      });
      updateProgressBar();
    }
    function createTodoElement({ text, description, category, priority, date, tags, done, notes }) {
      const li = document.createElement('li');
      if (done) li.classList.add('completed');
      // Checkbox
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = done;
      checkbox.className = 'checkbox';
      checkbox.onchange = () => toggleComplete(text);

      // Task details
      const taskDetails = document.createElement('div');
      taskDetails.className = 'task-details';

      // Tags
      if (tags && Array.isArray(tags)) {
        tags.forEach(t => {
          const chip = document.createElement('span');
          chip.className = 'tag-chip';
          chip.textContent = t;
          taskDetails.appendChild(chip);
        });
      }
      // Main text
      const mainText = document.createElement('div');
      mainText.contentEditable = true;
      mainText.textContent = `${text}`;
      mainText.oninput = () => updateText(text, mainText.textContent);
      mainText.spellcheck = true;
      mainText.title = "Click and edit";

      // Description
      const desc = document.createElement('div');
      desc.textContent = description;
      desc.style.fontSize = '0.9em';
      desc.style.color = '#333';

      // Category
      const cat = document.createElement('div');
      cat.textContent = category || "";
      cat.style.fontSize = "0.92em";
      cat.style.color = "#185a9d";
      cat.style.fontWeight = "bold";

      // Priority
      const priorityText = document.createElement('div');
      priorityText.className = `priority-label priority-${priority}`;
      priorityText.textContent = `Priority ${priority}`;

      // Date/Countdown
      const dateText = document.createElement('div');
      dateText.textContent = getCountdownText(date);
      // Reminder icon if due today or overdue
      if(dateText.textContent.includes("today") || dateText.textContent.includes("Overdue")) {
        const remindIcon = document.createElement('span');
        remindIcon.className = 'reminder-icon';
        remindIcon.title = 'Due soon!';
        remindIcon.innerHTML = '<i class="fa-solid fa-bell"></i>';
        dateText.appendChild(remindIcon);
      }

      // Notes button
      const notesBtn = document.createElement('button');
      notesBtn.className = 'notes-btn';
      notesBtn.innerHTML = '<i class="fa fa-sticky-note"></i> Notes';
      notesBtn.onclick = function(e) {
        e.stopPropagation();
        showNotesPopup(li, text, notes || "");
      };

      taskDetails.append(mainText, desc, cat, priorityText, dateText, notesBtn);

      // Delete button
      const btn = document.createElement('button');
      btn.className = 'delete-btn';
      btn.innerHTML = '<i class="fa fa-trash"></i>';
      btn.title = "Delete Task";
      btn.onclick = () => deleteTodo(text);

      li.append(checkbox, taskDetails, btn);
      return li;
    }
    function getCountdownText(dateStr) {
      if (!dateStr) return '';
      const today = new Date(); today.setHours(0,0,0,0);
      const due = new Date(dateStr); due.setHours(0,0,0,0);
      const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
      if (diff < 0) return '‚ö†Ô∏è Overdue';
      if (diff === 0) return 'Due today!';
      if (diff === 1) return 'Due tomorrow';
      return `Due in ${diff} days`;
    }
    function addTodo() {
      const text = document.getElementById('todoInput').value.trim();
      const description = document.getElementById('descInput').value.trim();
      const tagsStr = document.getElementById('tagsInput').value.trim();
      const category = document.getElementById('categoryInput').value;
      const priority = document.getElementById('priorityInput').value;
      const date = document.getElementById('dateInput').value;
      if (!text) return;
      const tags = tagsStr ? tagsStr.split(",").map(s=>s.trim()).filter(Boolean) : [];
      const todo = { text, description, category, priority, date, tags, done: false, notes: "" };
      projects[currentProject].todos.push(todo);
      saveProjects();
      renderTodos();
      document.getElementById('todoInput').value = '';
      document.getElementById('descInput').value = '';
      document.getElementById('tagsInput').value = '';
    }
    function deleteTodo(text) {
      const data = projects[currentProject];
      let idx = data.todos.findIndex(t => t.text === text);
      if (idx > -1) {
        lastDeleted = data.todos[idx];
        lastDeletedFrom = "todos";
        data.todos.splice(idx, 1);
      } else {
        idx = data.completed.findIndex(t => t.text === text);
        if (idx > -1) {
          lastDeleted = data.completed[idx];
          lastDeletedFrom = "completed";
          data.completed.splice(idx, 1);
        }
      }
      launchConfetti();
      saveProjects();
      renderTodos();
      showUndoBar("Task deleted!");
    }
    function showUndoBar(msg) {
      undoMsg.textContent = msg;
      undoBar.classList.add("show");
      setTimeout(()=>{ undoBar.classList.remove("show"); }, 6000);
    }
    function undoDelete() {
      if(!lastDeleted) return;
      if (lastDeletedFrom === "todos") {
        projects[currentProject].todos.push(lastDeleted);
      } else if (lastDeletedFrom === "completed") {
        projects[currentProject].completed.push(lastDeleted);
      }
      saveProjects(); renderTodos();
      undoBar.classList.remove("show");
      lastDeleted = null; lastDeletedFrom = null;
    }
    function toggleComplete(text) {
      const data = projects[currentProject];
      const index = data.todos.findIndex(t => t.text === text);
      if (index > -1) {
        const todo = data.todos.splice(index, 1)[0];
        todo.done = true;
        data.completed.push(todo);
      } else {
        const idx = data.completed.findIndex(t => t.text === text);
        if (idx > -1) {
          const todo = data.completed.splice(idx, 1)[0];
          todo.done = false;
          data.todos.push(todo);
        }
      }
      saveProjects();
      renderTodos();
    }
    function updateText(oldText, newText) {
      const data = projects[currentProject];
      for (let list of [data.todos, data.completed]) {
        const item = list.find(t => t.text === oldText);
        if (item) item.text = newText;
      }
      saveProjects();
    }
    function launchConfetti() {
      confetti({ particleCount: 100, spread: 80, origin: { y: 0.6 } });
    }
    // Progress Bar
    function updateProgressBar() {
      const { todos, completed } = projects[currentProject] || {todos:[],completed:[]};
      const total = todos.length + completed.length;
      let percent = 0;
      if (total > 0) percent = Math.round((completed.length / total) * 100);
      progressBarFill.textContent = ""; // text moved to label
      progressBarFill.style.width = percent + "%";
      if(percent === 100 && total > 0) {
        progressBarLabel.textContent = "üéâ All tasks done!";
        progressBarFill.style.background = "linear-gradient(90deg,#36d1c4 0%,#b06ab3 100%)";
      }
      else {
        progressBarLabel.textContent = percent + "% Complete";
        progressBarFill.style.background = "linear-gradient(90deg,#43cea2,#185a9d)";
      }
    }
    // Notes popup
    function showNotesPopup(parentLi, taskText, currNotes) {
      let popup = parentLi.querySelector('.notes-popup');
      if(!popup) {
        popup = document.createElement('div');
        popup.className = "notes-popup";
        popup.innerHTML = `
          <b>Task Notes</b><br>
          <textarea style="width:98%;min-height:60px;font-family:inherit;font-size:1em;border-radius:7px;border:1px solid #ccc;padding:4px 7px;resize:vertical;">${currNotes||""}</textarea>
          <br>
          <button style="margin-top:7px;background:#43cea2;color:#fff;padding:6px 13px;border-radius:7px;border:none;font-weight:bold;cursor:pointer;">Save</button>
        `;
        parentLi.appendChild(popup);
        // Save button handler
        popup.querySelector('button').onclick = function(){
          updateNotes(taskText, popup.querySelector('textarea').value);
          popup.classList.remove('show');
        };
        // Remove popup on outside click
        document.addEventListener('mousedown', function handler(e){
          if(!popup.contains(e.target)) { popup.classList.remove('show'); document.removeEventListener('mousedown', handler);}
        });
      }
      popup.classList.add('show');
      popup.querySelector('textarea').focus();
    }
    function updateNotes(text, value) {
      const data = projects[currentProject];
      for (let list of [data.todos, data.completed]) {
        const item = list.find(t => t.text === text);
        if (item) item.notes = value;
      }
      saveProjects();
    }
    // THEME toggle
    const themeToggleBtn = document.getElementById('themeToggle');
    let isDark = localStorage.getItem("theme") === "dark";
    function applyTheme() {
      if(isDark) {
        document.body.style.color = "#e1e7f0";
        document.body.style.background = "linear-gradient(135deg,#283e51,#485563)";
        document.querySelector('.container').style.background = "rgba(21,34,56,0.63)";
        themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        document.body.style.color = "#222";
        document.body.style.background = "";
        document.querySelector('.container').style.background = "rgba(255,255,255,0.5)";
        themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
      }
    }
    themeToggleBtn.onclick = function() {
      isDark = !isDark;
      localStorage.setItem("theme", isDark ? "dark" : "light");
      applyTheme();
    };
    if(isDark) applyTheme();

    // Hotkeys: N for new todo, S for search, P for new project, Q for quote, T for theme
    window.addEventListener('keydown', e => {
      if(document.activeElement.tagName==="INPUT"||document.activeElement.tagName==="TEXTAREA") return;
      if(e.key.toLowerCase()==="n") document.getElementById('todoInput').focus();
      if(e.key.toLowerCase()==="s") projectSearchBar.focus();
      if(e.key.toLowerCase()==="p") addProject();
      if(e.key.toLowerCase()==="q") showRandomQuote();
      if(e.key.toLowerCase()==="t") themeToggleBtn.click();
    });

    // Notifications for due tasks (if any due today!)
    function notifyDueSoonTasks() {
      if (!("Notification" in window)) return;
      if (Notification.permission !== "granted") return;
      const { todos } = projects[currentProject];
      const today = new Date(); today.setHours(0,0,0,0);
      todos.forEach(task => {
        if (task.date) {
          const due = new Date(task.date); due.setHours(0,0,0,0);
          if (due - today === 0) {
            new Notification("Task Due Today", { body: task.text, icon:"https://cdn-icons-png.flaticon.com/512/2921/2921222.png" });
          }
        }
      });
    }
    // On load, ask notifications permission
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission();
    }
    setTimeout(notifyDueSoonTasks, 1200);

    // --- INIT ---
    showRandomQuote();
    renderProjectList();
    renderTodos();
  </script>
</body>
</html>
