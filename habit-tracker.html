 <!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8">
<!DOCTYPE html>
<html lang="en">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" type="image/x-icon" href="Untitled.png">
<head>
  <meta charset="UTF-8">
  <title>HabitFlow — Next-Gen Habit Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" type="image/x-icon" href="Untitled.png">
  <!-- Google Fonts & Font Awesome -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Montserrat:wght@800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --primary: #0a192f;
      --primary-dark: #020c1b;
      --primary-light: #112240;
      --accent: #64ffda;
      --accent-dark: #14b8a6;
      --bg: linear-gradient(120deg, #0a192f 0%, #233554 60%, #1f2937 100%);
      --card-bg: #112240;
      --white: #fff;
      --text: #dbeafe;
      --text-light: #a7c7e7;
      --gray: #6b7280;
      --shadow: 0 8px 32px #14b8a629, 0 2px 8px #0a192f33;
      --radius: 1.4rem;
      --danger: #ff5f56;
      --success: #4ade80;
      --warning: #facc15;
      --info: #60a5fa;
      --alarm: #f87171;
      --muted: #334155;
      --progress-bg: #233554;
      --custom-purple: #6d28d9;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: var(--bg);
      font-family: 'Inter', Arial, sans-serif;
      color: var(--text);
      width: 100vw;
      overflow-x: hidden;
      transition: background 0.6s;
      font-size: 17px;
    }
    .habit-app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2vw 3vw 2vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: rgba(17,34,64,0.93);
      border-radius: 2.2em;
      box-shadow: 0 8px 32px #14b8a633;
      margin-top: 3vw;
      position: relative;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1em;
      flex-wrap: wrap;
      padding-top: 2vw;
      margin-bottom: 1.7vw;
    }
    .header-title {
      font-size: 2.3rem;
      font-family: 'Montserrat', sans-serif;
      font-weight: 800;
      letter-spacing: -1.6px;
      background: linear-gradient(90deg, #64ffda 25%, #60a5fa 65%, #6d28d9 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 0.6em;
      text-shadow: 0 3px 24px #14b8a633;
    }
    .dashboard-btn {
      text-decoration: none;
      background: linear-gradient(90deg, #1f2937 70%, #64ffda 100%);
      color: #fff;
      padding: 0.76em 2em;
      border-radius: 1.2em;
      font-size: 1.18em;
      font-weight: 700;
      box-shadow: 0 2px 14px #14b8a633;
      transition: background 0.12s, box-shadow 0.12s;
      display: flex;
      gap: 0.55em;
      align-items: center;
      border: none;
      cursor: pointer;
    }
    .dashboard-btn:hover {
      background: linear-gradient(90deg, #14b8a6 60%, #60a5fa 100%);
      color: #fff;
      box-shadow: 0 4px 18px #64ffda66;
    }
    .add-habit-btn {
      display: flex;
      align-items: center;
      gap: 0.7em;
      background: var(--accent);
      color: #001219;
      font-size: 1.18em;
      font-weight: 700;
      border: none;
      border-radius: 1em;
      padding: 0.82em 2.1em;
      margin-top: 0.5em;
      margin-bottom: 2.2em;
      cursor: pointer;
      box-shadow: 0 2px 12px #64ffda33;
      transition: background 0.14s, box-shadow 0.11s, color 0.14s;
    }
    .add-habit-btn:hover {
      background: var(--custom-purple);
      color: #fff;
    }
    .modal-bg, .settings-modal-bg {
      display: none;
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(17,24,39,0.23);
      z-index: 99;
      align-items: center;
      justify-content: center;
    }
    .modal-bg.active, .settings-modal-bg.active { display: flex; }
    .modal, .settings-modal {
      background: #192041;
      border-radius: 1.5em;
      padding: 2.7em 2.7em 1.8em 2.7em;
      box-shadow: var(--shadow);
      min-width: 340px;
      max-width: 99vw;
      max-height: 98vh;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 1.3em;
      z-index: 199;
      animation: fadeIn 0.23s;
      color: var(--text);
    }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.97);} to {opacity: 1; transform: scale(1);} }
    .modal-close {
      position: absolute;
      right: 1.5em; top: 1.5em;
      background: none;
      border: none;
      font-size: 1.38em;
      color: #888;
      cursor: pointer;
      z-index: 1;
    }
    .modal h2, .settings-modal h2 {
      margin: 0 0 0.4em 0;
      color: var(--accent);
      font-weight: 900;
      font-size: 1.6em;
      letter-spacing: -0.6px;
    }
    .form-row {
      display: flex;
      gap: 1.15em;
      margin-bottom: 0.8em;
      flex-wrap: wrap;
      align-items: center;
    }
    .form-row label {
      font-weight: 600;
      font-size: 1.13em;
      color: var(--accent-dark);
      margin-right: 0.38em;
      min-width: 80px;
    }
    .form-row input, .form-row select {
      font-size: 1.09em;
      border-radius: 1em;
      border: 1.6px solid #233554;
      background: #0f172a;
      padding: 0.43em 1.1em;
      outline: none;
      font-family: inherit;
      color: var(--text);
      transition: border 0.13s, background 0.13s;
    }
    .form-row input:focus, .form-row select:focus {
      border: 1.7px solid var(--accent-dark);
      background: #233554;
    }
    .form-row input[type="color"] {
      padding: 0.15em 0.2em;
      width: 42px;
      height: 42px;
      border-radius: 0.7em;
      border: none;
    }
    .form-row input[type="time"] {
      min-width: 90px;
    }
    .icon-selection {
      display: flex;
      gap: 0.32em;
      flex-wrap: wrap;
      margin-top: 0.2em;
    }
    .icon-choice {
      font-size: 1.42em;
      padding: 0.16em 0.3em;
      border-radius: 0.56em;
      cursor: pointer;
      border: 2px solid transparent;
      background: #233554;
      transition: border 0.13s, background 0.13s;
    }
    .icon-choice:hover, .icon-choice.selected {
      border-color: var(--accent);
      background: #1e293b;
    }
    .habit-list-section {
      margin-bottom: 2.9em;
      margin-top: 1.6em;
      width: 100%;
    }
    .habits-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 2.2em 2em;
      justify-content: flex-start;
      width: 100%;
    }
    .habit-card {
      background: var(--card-bg);
      border-radius: 1.5em;
      box-shadow: var(--shadow);
      padding: 1.5em 2em 1.15em 2em;
      min-width: 270px;
      display: flex;
      flex-direction: column;
      gap: 1.1em;
      position: relative;
      border: 2.5px solid #233554;
      transition: border 0.16s, box-shadow 0.13s;
      width: 100%;
      max-width: 430px;
    }
    .habit-card[data-streak] {
      border-color: var(--accent);
      box-shadow: 0 6px 36px #64ffda33;
    }
    .habit-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.7em;
    }
    .habit-title {
      font-size: 1.23em;
      font-weight: 800;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.55em;
      letter-spacing: -0.5px;
      flex-wrap: wrap;
    }
    .habit-emoji {
      font-size: 1.7em;
      margin-right: 0.13em;
      border-radius: 0.3em;
      padding: 0.03em 0.15em;
      background: #233554;
      border: 1.3px solid #14b8a655;
      box-shadow: 0 1.5px 6px #14b8a609;
    }
    .habit-target {
      font-size: 0.99em;
      font-weight: 600;
      color: var(--info);
      background: #233554;
      border-radius: 0.7em;
      padding: 0.19em 0.73em;
      margin-left: 0.6em;
      letter-spacing: 0.01em;
    }
    .importance-badge {
      font-size: 0.97em;
      font-weight: 700;
      border-radius: 0.7em;
      padding: 0.16em 0.65em;
      margin-left: 0.7em;
      letter-spacing: 0.01em;
      background: #233554;
      color: #facc15;
      border: 1.2px solid #facc1588;
      box-shadow: 0 1px 6px #facc1511;
      display: inline-block;
    }
    .importance-badge.high { background:#1e293b; color:#ff5f56; border-color:#ff5f56;}
    .importance-badge.medium { background:#233554; color:#facc15; border-color:#facc15;}
    .importance-badge.low { background:#1e293b; color:#6b7280; border-color:#6b7280;}
    .habit-actions {
      display: flex;
      gap: 0.7em;
      align-items: center;
    }
    .habit-action-btn {
      background: none;
      border: none;
      border-radius: 0.7em;
      color: #94a3b8;
      font-size: 1.23em;
      padding: 0.22em 0.46em;
      cursor: pointer;
      transition: color 0.13s, background 0.12s;
    }
    .habit-action-btn:hover {
      background: #1e293b;
      color: var(--accent);
    }
    .habit-calendar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3em;
      margin-bottom: 0.7em;
      align-items: center;
      justify-content: start;
    }
    .calendar-day {
      width: 36px;
      height: 36px;
      border-radius: 0.9em;
      background: #233554;
      color: #a7c7e7;
      font-size: 1.13em;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.14s, color 0.14s, box-shadow 0.11s;
      border: 1.1px solid #112240;
      box-shadow: 0 1.5px 6px #14b8a633;
      user-select: none;
      position: relative;
    }
    .calendar-day.completed {
      background: var(--success);
      color: #192041;
      border-color: var(--success);
      box-shadow: 0 1.5px 6px #4ade8033;
      position: relative;
    }
    .calendar-day.missed {
      background: var(--danger);
      color: #fff;
      border-color: var(--danger);
    }
    .calendar-day.future {
      background: #1e293b;
      color: #6b7280;
      border-color: #6b7280;
      cursor: not-allowed;
    }
    .calendar-day.today:not(.completed) {
      border-color: var(--accent);
      background: #64ffda33;
      color: var(--accent-dark);
      font-weight: 700;
    }
    .calendar-day .fa-check {
      font-size: 1.03em;
      color: #192041;
    }
    .calendar-day .fa-xmark {
      color: #fff;
      font-size: 1.13em;
    }
    .calendar-day .fa-clock {
      color: var(--accent-dark);
      font-size: 1.13em;
    }
    .calendar-day:hover:not(.completed):not(.future) {
      background: var(--accent-dark);
      color: #fff;
      border-color: var(--accent);
    }
    .habit-schedule-link {
      color: var(--info);
      font-size: 1em;
      text-decoration: underline;
      cursor: pointer;
      margin-top: 0.2em;
      margin-bottom: 0.5em;
      background: transparent;
      border: none;
      padding: 0;
      font-weight: 600;
      transition: color 0.13s;
    }
    .habit-schedule-link:hover { color: var(--accent);}
    .habit-stats {
      display: flex;
      align-items: center;
      gap: 1.2em;
      font-size: 1.08em;
      margin-top: 0.3em;
      flex-wrap: wrap;
    }
    .stat {
      display: flex;
      align-items: center;
      gap: 0.38em;
      background: #1e293b;
      color: var(--accent);
      border-radius: 0.7em;
      padding: 0.12em 0.95em 0.12em 0.65em;
      font-weight: 700;
      font-size: 0.97em;
      box-shadow: 0 1px 6px #14b8a609;
    }
    .stat .fa-fire { color: var(--danger);}
    .stat .fa-check-circle { color: var(--success);}
    .stat .fa-bolt { color: var(--warning);}
    .stat .fa-flag-checkered { color: var(--accent);}
    .habit-progress-bar {
      width: 100%;
      height: 14px;
      background: var(--progress-bg);
      border-radius: 0.7em;
      overflow: hidden;
      margin-top: 0.9em;
      margin-bottom: 0.2em;
      position: relative;
    }
    .progress-bar-inner {
      height: 100%;
      background: linear-gradient(90deg, #4ade80 30%, #14b8a6 100%);
      border-radius: 0.7em 0.7em 0.7em 0.7em;
      transition: width 0.19s cubic-bezier(.64,.39,.44,1.07);
      min-width: 7px;
    }
    .progress-bar-label {
      position: absolute;
      right: 10px;
      top: 1.1px;
      color: #4ade80;
      font-weight: 600;
      font-size: 0.99em;
      letter-spacing: 0.01em;
      text-shadow: 0 1px 4px #192041;
    }
    /* Schedule Modal */
    .schedule-modal-bg {
      display: none;
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(17,24,39,0.18);
      z-index: 90;
      align-items: center;
      justify-content: center;
    }
    .schedule-modal-bg.active { display: flex; }
    .schedule-modal {
      background: #192041;
      border-radius: 1.4em;
      padding: 1.4em 1.7em 1.4em 1.7em;
      box-shadow: var(--shadow);
      min-width: 320px;
      max-width: 97vw;
      max-height: 93vh;
      position: relative;
      overflow-y: auto;
      animation: fadeIn 0.24s;
      color: var(--text);
    }
    .schedule-modal h3 {
      margin-top: 0;
      color: var(--accent);
      font-size: 1.22em;
      font-weight: 900;
      margin-bottom: 0.8em;
    }
    .schedule-calendar {
      display: grid;
      grid-template-columns: repeat(7, 40px);
      gap: 0.35em;
      margin-bottom: 0.7em;
      max-width: 100vw;
    }
    .calendar-small-day {
      width: 40px; height: 40px;
      border-radius: 0.9em;
      background: #233554;
      color: #a7c7e7;
      font-size: 1.03em;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.14s, color 0.14s, box-shadow 0.11s;
      border: 1.1px solid #112240;
      margin-bottom: 0.1em;
      margin-top: 0.1em;
      user-select: none;
      position: relative;
    }
    .calendar-small-day.completed {
      background: var(--success);
      color: #192041;
      border-color: var(--success);
    }
    .calendar-small-day.missed {
      background: var(--danger);
      color: #fff;
      border-color: var(--danger);
    }
    .calendar-small-day.future {
      background: #1e293b;
      color: #6b7280;
      border-color: #6b7280;
      cursor: not-allowed;
    }
    .calendar-small-day .fa-check {
      font-size: 1.02em;
      color: #192041;
    }
    .calendar-small-day .fa-xmark {
      color: #fff;
      font-size: 1.12em;
    }
    .calendar-small-day .fa-clock {
      color: var(--accent-dark);
      font-size: 1.12em;
    }
    .calendar-small-day.today:not(.completed) {
      border-color: var(--accent);
      background: #64ffda33;
      color: var(--accent-dark);
      font-weight: 700;
    }
    .schedule-modal .modal-close {
      position: absolute;
      right: 1.1em; top: 1.1em;
      background: none;
      border: none;
      font-size: 1.25em;
      color: #888;
      cursor: pointer;
    }
    .schedule-legend {
      display: flex;
      gap: 1em;
      margin-top: 1em;
      font-size: 0.98em;
      color: #94a3b8;
      align-items: center;
    }
    .schedule-legend span {
      display: flex;
      align-items: center;
      gap: 0.2em;
    }
    .legend-box {
      width: 18px;
      height: 18px;
      border-radius: 0.5em;
      display: inline-block;
      margin-right: 0.2em;
      border: 1.2px solid #334155;
    }
    .legend-completed { background: var(--success);}
    .legend-missed { background: var(--danger);}
    .legend-future { background: #1e293b;}
    /* Responsive */
    @media (max-width: 900px) {
      .habit-app { padding: 0 1vw; }
      .habits-list { gap: 2em 1.2em; }
      .habit-card { min-width: 210px; max-width: 98vw; }
      .header-title { font-size: 1.55rem;}
      .schedule-calendar { grid-template-columns: repeat(7, 30px);}
    }
    @media (max-width: 600px) {
      .header-title { font-size: 1.1rem;}
      .habit-app { padding: 0 0.2em;}
      .habit-card { min-width: 92vw; }
      .habits-list { gap: 1.2em 0.3em;}
      .schedule-calendar { grid-template-columns: repeat(7, 22vw);}
    }
    /* Custom period input */
    .custom-period-row { display: flex; align-items: center; gap: 0.7em; }
    .custom-period-row input { min-width: 150px; }
    .alarm-row {
      display: flex;
      gap: 1em;
      align-items: center;
      margin-bottom: 0.6em;
    }
    .alarm-label {
      background: var(--alarm);
      color: #fff;
      border-radius: 1em;
      padding: 0.13em 1.05em;
      font-weight: 700;
      font-size: 1em;
      margin-right: 0.3em;
      margin-left: 0.6em;
    }
    .alarm-off {
      background: #334155;
      color: #fff;
    }
    .alarm-toggle-btn {
      background: var(--accent);
      color: #112240;
      font-weight: bold;
      border: none;
      border-radius: 1em;
      padding: 0.32em 1.2em;
      font-size: 1.09em;
      margin-left: 1em;
      transition: background 0.14s;
      cursor: pointer;
    }
    .alarm-toggle-btn.alarmed {
      background: var(--danger);
      color: #fff;
    }
    .alarm-toggle-btn:hover {
      background: var(--custom-purple);
      color: #fff;
    }
    /* Alarm modal */
    .alarm-modal-bg {
      display: none;
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(17,24,39,0.38);
      z-index: 299;
      align-items: center;
      justify-content: center;
    }
    .alarm-modal-bg.active { display: flex; }
    .alarm-modal {
      background: #fff;
      color: #0a192f;
      border-radius: 1.2em;
      box-shadow: 0 12px 64px #f8717133;
      min-width: 290px;
      max-width: 92vw;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5em;
      padding: 3em 1.6em 2em 1.6em;
      z-index: 999;
      animation: fadeIn 0.2s;
      font-size: 1.15em;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-align: center;
      position: relative;
    }
    .alarm-modal .modal-close {
      color: #0a192f;
      right: 0.7em;
      top: 0.7em;
      font-size: 1.2em;
      position: absolute;
    }
    .alarm-modal button {
      background: var(--accent);
      color: #102a43;
      border: none;
      border-radius: 1em;
      padding: 0.52em 2em;
      font-size: 1.13em;
      font-weight: bold;
      cursor: pointer;
      margin-top: 0.7em;
      transition: background 0.18s;
    }
    .alarm-modal button:hover {
      background: var(--custom-purple);
      color: #fff;
    }
    /* Theme toggle, import/export, journal unchanged. */
    .theme-toggle {
      position: absolute;
      top: 1.3em;
      left: 1.5em;
      background: #233554;
      color: var(--accent);
      border: none;
      border-radius: 1em;
      font-size: 1.2em;
      padding: 0.35em 0.85em;
      cursor: pointer;
      transition: background 0.18s;
      box-shadow: 0 1px 6px #64ffda22;
    }
    .theme-toggle:hover {
      background: var(--accent);
      color: #0a192f;
    }
    .import-export-row {
      display: flex;
      gap: 0.5em;
      margin-top: 1em;
      align-items: center;
    }
    .import-btn, .export-btn {
      background: var(--accent);
      color: #0a192f;
      border: none;
      border-radius: 0.7em;
      padding: 0.5em 1.2em;
      font-weight: 700;
      font-size: 1.05em;
      cursor: pointer;
      margin-right: 0.2em;
      transition: background 0.14s;
    }
    .import-btn:hover, .export-btn:hover {
      background: var(--custom-purple);
      color: #fff;
    }
    .journal-entry-row {
      display: flex;
      flex-direction: column;
      gap: 0.2em;
      margin-top: 0.9em;
      background: #1e293b;
      border-radius: 0.7em;
      padding: 0.5em 1em;
    }
    .journal-entry-row label {
      font-size:0.97em;
      color: var(--accent);
    }
    .journal-entry-row textarea {
      border-radius: 0.5em;
      border: 1px solid #233554;
      background: #192041;
      color: var(--text);
      font-size: 1em;
      resize: vertical;
      min-height: 2.7em;
      max-height: 6em;
      outline: none;
      padding: 0.3em 0.7em;
    }
    .journal-entry-row textarea:focus {
      border-color: var(--accent-dark);
    }
    .journal-entry-list {
      background: #192041;
      margin-top: 0.45em;
      border-radius: 0.5em;
      padding: 0.3em 1em 0.7em 1em;
      color: #a7c7e7;
      font-size: 0.99em;
      max-height: 6em;
      overflow-y: auto;
    }
    .wb-hint {
      position: fixed;
      left: 50%;
      bottom: 2.4em;
      transform: translateX(-50%);
      background: var(--accent);
      color: #0a192f;
      font-size: 1.1em;
      border-radius: 1.2em;
      padding: 0.8em 2em;
      font-weight: bold;
      box-shadow: 0 2px 12px #14b8a629;
      z-index: 2500;
      letter-spacing: 0.02em;
    }
  </style>
</head>
<body>
  <div class="habit-app" id="habit-app">
    <div class="header">
      <div class="header-title"><i class="fa-solid fa-seedling"></i> Habit Tracker</div>
      <a class="dashboard-btn" href="index.html"><i class="fa-solid fa-arrow-left"></i>Dashboard</a>
    </div>
    <button class="add-habit-btn" id="add-habit-btn"><i class="fa-solid fa-plus"></i> Add Habit</button>
    <!-- Add/Edit Habit Modal -->
    <div class="modal-bg" id="habit-modal-bg">
      <form class="modal" id="habit-modal" autocomplete="off">
        <button type="button" class="modal-close" id="modal-close-btn"><i class="fa-solid fa-times"></i></button>
        <h2 id="modal-title">Add Habit</h2>
        <button type="button" class="theme-toggle" id="theme-toggle" title="Toggle theme"><i class="fa-solid fa-moon"></i></button>
        <div class="form-row">
          <label>Icon</label>
          <div id="icon-picker" class="icon-selection"></div>
          <input type="hidden" id="habit-emoji">
        </div>
        <div class="form-row">
          <label for="habit-title">Name</label>
          <input type="text" id="habit-title" maxlength="32" placeholder="e.g. Drink Water" required>
        </div>
        <div class="form-row">
          <label for="habit-color">Color</label>
          <input type="color" id="habit-color" value="#64ffda">
        </div>
        <div class="form-row">
          <label for="habit-importance">Importance</label>
          <select id="habit-importance">
            <option value="high">🔥 High</option>
            <option value="medium" selected>⭐ Medium</option>
            <option value="low">💤 Low</option>
          </select>
        </div>
        <div class="form-row">
          <label for="habit-frequency">Frequency</label>
          <select id="habit-frequency">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="form-row" id="custom-period-row" style="display:none;">
          <label for="habit-custom-period">Custom period</label>
          <input type="text" id="habit-custom-period" maxlength="36" placeholder="Describe your period, e.g. every 2 days" />
        </div>
        <div class="form-row">
          <label for="habit-target">Goal</label>
          <input type="number" id="habit-target" min="1" max="31" value="1" style="width:4em;">
          <span id="goal-label">per day</span>
        </div>
        <div class="alarm-row">
          <label for="habit-alarm">Alarm</label>
          <input type="time" id="habit-alarm" step="60">
          <span class="alarm-label alarm-off" id="alarm-status-label">Off</span>
          <button type="button" class="alarm-toggle-btn" id="alarm-toggle-btn">Set Alarm</button>
        </div>
        <div class="form-row">
          <label for="habit-template">Template</label>
          <select id="habit-template">
            <option value="">-- None --</option>
            <option value="water">Drink Water</option>
            <option value="read">Read Book</option>
            <option value="exercise">Exercise</option>
            <option value="meditate">Meditate</option>
            <option value="sleep">Sleep Early</option>
          </select>
        </div>
        <div class="journal-entry-row">
          <label for="habit-journal">Add Journal Entry (today):</label>
          <textarea id="habit-journal" maxlength="400" placeholder="Write your thoughts or notes..."></textarea>
          <div class="journal-entry-list" id="journal-list"></div>
        </div>
        <button type="submit" class="add-habit-btn" style="font-size:1.09em"><i class="fa-solid fa-check"></i> Save Habit</button>
      </form>
    </div>
    <!-- Schedule Modal -->
    <div class="schedule-modal-bg" id="schedule-modal-bg">
      <div class="schedule-modal" id="schedule-modal">
        <button type="button" class="modal-close" id="schedule-close-btn"><i class="fa-solid fa-times"></i></button>
        <h3 id="schedule-title">Habit Schedule</h3>
        <div class="schedule-calendar" id="schedule-calendar"></div>
        <div class="schedule-legend">
          <span><span class="legend-box legend-completed"></span>Completed</span>
          <span><span class="legend-box legend-missed"></span>Missed</span>
          <span><span class="legend-box legend-future"></span>Future</span>
        </div>
      </div>
    </div>
    <!-- Alarm Ring Modal -->
    <div class="alarm-modal-bg" id="alarm-modal-bg">
      <div class="alarm-modal" id="alarm-modal">
        <button type="button" class="modal-close" id="alarm-close-btn"><i class="fa-solid fa-times"></i></button>
        <div id="alarm-modal-title">⏰ Time for your habit!</div>
        <div id="alarm-modal-body"></div>
        <button type="button" id="alarm-stop-btn">Stop Alarm</button>
      </div>
    </div>
    <!-- Settings Modal -->
    <div class="settings-modal-bg" id="settings-modal-bg">
      <div class="settings-modal">
        <button type="button" class="modal-close" id="settings-close-btn"><i class="fa-solid fa-times"></i></button>
        <div style="margin:0.7em 0 1.2em 0">
          <button class="theme-toggle" id="settings-theme-toggle"><i class="fa-solid fa-moon"></i> Toggle Theme</button>
        </div>
        <div class="import-export-row">
          <button class="export-btn" id="export-btn"><i class="fa-solid fa-download"></i> Export Data</button>
          <input type="file" id="import-file" accept=".json" style="display:none;">
          <button class="import-btn" id="import-btn"><i class="fa-solid fa-upload"></i> Import Data</button>
        </div>
      </div>
    </div>
    <button class="settings-btn" id="open-settings-btn" title="Settings" style="position:fixed;left:2vw;bottom:2vw;z-index:201;background:var(--card-bg);color:var(--accent);font-size:1.7em;border:none;border-radius:50%;width:62px;height:62px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 24px #0a192f44;cursor:pointer;transition:box-shadow 0.2s,background 0.2s;"><i class="fa-solid fa-gear"></i></button>
    <section class="habit-list-section">
      <div class="habits-list" id="habits-list"></div>
    </section>
  </div>
  <div class="wb-hint" id="wb-hint" style="display:none"></div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ====== ICON PICKER ======
    const ICONS = [
      "🌱","💧","🏃","🚰","📖","🧘","😴","🍎","☀️","🪥","🍵","😊","📚",
      "🧹","🤸","🧑‍💻","🎨","💪","🥦","🏊","🧗","🦷","💤","🛏️","🏋️",
      "🚴","✍️","🥗","🎹","🧑‍🍳","🦸","🧑‍🎤","🧑‍🎓","🔋","🛡️","🧑‍🔬","🏕️","🧑‍🎨","🧑‍🔧","🧑‍🚒","🧑‍🌾","🧑‍✈️","🎻","🎸","🎼","🧑‍🏫"
    ];
    const iconPicker = document.getElementById('icon-picker');
    function renderIconPicker(selected) {
      iconPicker.innerHTML = "";
      ICONS.forEach(icon => {
        const b = document.createElement('span');
        b.className = "icon-choice" + (icon===selected?" selected":"");
        b.innerText = icon;
        b.onclick = ()=>{
          document.querySelectorAll('.icon-choice').forEach(e=>e.classList.remove('selected'));
          b.classList.add('selected');
          document.getElementById('habit-emoji').value = icon;
        };
        iconPicker.appendChild(b);
      });
    }
    renderIconPicker(ICONS[0]);
    document.getElementById('habit-emoji').value = ICONS[0];

    // ====== UTILITIES ======
    function todayStr() {
      const d = new Date();
      return d.toISOString().slice(0,10);
    }
    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay() || 7;
      if (day !== 1) d.setDate(d.getDate() - (day-1));
      d.setHours(0,0,0,0);
      return d;
    }
    function showHint(msg) {
      let hint = document.getElementById('wb-hint');
      hint.textContent = msg;
      hint.style.display = '';
      clearTimeout(hint._timeout);
      hint._timeout = setTimeout(() => { hint.style.display = 'none'; }, 1800);
    }
    function getImportanceBadge(importance) {
      if (importance === "high") return `<span class="importance-badge high">🔥 High</span>`;
      if (importance === "medium") return `<span class="importance-badge medium">⭐ Medium</span>`;
      return `<span class="importance-badge low">💤 Low</span>`;
    }
    function getRandomColor() {
      // cool palette
      const colors = ["#64ffda","#60a5fa","#6d28d9","#facc15","#4ade80","#a21caf","#f87171","#f472b6"];
      return colors[Math.floor(Math.random()*colors.length)];
    }

    // ====== HABIT DATA MODEL ======
    function getHabits() {
      return JSON.parse(localStorage.getItem('habitflow_habits')||'[]');
    }
    function saveHabits(arr) {
      localStorage.setItem('habitflow_habits', JSON.stringify(arr));
    }
    function findHabit(id) {
      return getHabits().find(h => h.id === id);
    }

    // ====== THEME ======
    function enableDarkTheme() {
      document.documentElement.style.setProperty('--bg', 'linear-gradient(120deg,#0a192f 0%,#233554 60%,#1f2937 100%)');
      document.documentElement.style.setProperty('--card-bg', '#112240');
      document.documentElement.style.setProperty('--text', '#dbeafe');
      document.documentElement.style.setProperty('--accent', '#64ffda');
      document.body.classList.remove("light-theme");
      localStorage.setItem('theme', 'dark');
    }
    function enableLightTheme() {
      document.documentElement.style.setProperty('--bg', 'linear-gradient(120deg,#ecfeff 0%,#f1f5f9 60%,#e0e7ef 100%)');
      document.documentElement.style.setProperty('--card-bg', '#f9fafb');
      document.documentElement.style.setProperty('--text', '#1e293b');
      document.documentElement.style.setProperty('--accent', '#0a192f');
      document.body.classList.add("light-theme");
      localStorage.setItem('theme', 'light');
    }
    function toggleTheme() {
      if (document.body.classList.contains("light-theme")) enableDarkTheme();
      else enableLightTheme();
      document.querySelectorAll('.theme-toggle i').forEach(icon => {
        icon.className = document.body.classList.contains("light-theme") ? "fa-solid fa-moon" : "fa-solid fa-sun";
      });
    }

    // ====== UI, MODALS ======
    const modalBg = document.getElementById('habit-modal-bg');
    const modal = document.getElementById('habit-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalClose = document.getElementById('modal-close-btn');
    let editingHabitId = null;

    document.getElementById('add-habit-btn').onclick = () => openHabitModal();
    modalClose.onclick = () => closeHabitModal();
    modalBg.onclick = e => { if (e.target === modalBg) closeHabitModal(); };

    document.getElementById('theme-toggle').onclick = toggleTheme;
    document.getElementById('settings-theme-toggle').onclick = toggleTheme;

    // Custom period
    document.getElementById('habit-frequency').addEventListener("change", (e) => {
      if (e.target.value === "custom") {
        document.getElementById('custom-period-row').style.display = "";
        document.getElementById('goal-label').textContent = "per period";
        document.getElementById('habit-target').max = 365;
      } else {
        document.getElementById('custom-period-row').style.display = "none";
        document.getElementById('goal-label').textContent = e.target.value === "daily" ? "per day" : "per week";
        document.getElementById('habit-target').max = e.target.value==="daily"?7:31;
      }
    });

    document.getElementById('habit-template').onchange = function(e) {
      const t = e.target.value;
      if (t==="water") {
        document.getElementById('habit-title').value = "Drink Water";
        document.getElementById('habit-emoji').value = "💧";
        renderIconPicker("💧");
        document.getElementById('habit-color').value = "#64ffda";
        document.getElementById('habit-frequency').value = "daily";
        document.getElementById('habit-target').value = 8;
        document.getElementById('custom-period-row').style.display = "none";
      } else if (t==="read") {
        document.getElementById('habit-title').value = "Read Book";
        document.getElementById('habit-emoji').value = "📚";
        renderIconPicker("📚");
        document.getElementById('habit-color').value = "#6d28d9";
        document.getElementById('habit-frequency').value = "daily";
        document.getElementById('habit-target').value = 1;
        document.getElementById('custom-period-row').style.display = "none";
      } else if (t==="exercise") {
        document.getElementById('habit-title').value = "Exercise";
        document.getElementById('habit-emoji').value = "🏃";
        renderIconPicker("🏃");
        document.getElementById('habit-color').value = "#4ade80";
        document.getElementById('habit-frequency').value = "weekly";
        document.getElementById('habit-target').value = 4;
        document.getElementById('custom-period-row').style.display = "none";
      } else if (t==="meditate") {
        document.getElementById('habit-title').value = "Meditate";
        document.getElementById('habit-emoji').value = "🧘";
        renderIconPicker("🧘");
        document.getElementById('habit-color').value = "#facc15";
        document.getElementById('habit-frequency').value = "daily";
        document.getElementById('habit-target').value = 1;
        document.getElementById('custom-period-row').style.display = "none";
      } else if (t==="sleep") {
        document.getElementById('habit-title').value = "Sleep Early";
        document.getElementById('habit-emoji').value = "😴";
        renderIconPicker("😴");
        document.getElementById('habit-color').value = "#f87171";
        document.getElementById('habit-frequency').value = "daily";
        document.getElementById('habit-target').value = 1;
        document.getElementById('custom-period-row').style.display = "none";
      }
    }

    function openHabitModal(editing=false, habit=null) {
      modalBg.classList.add('active');
      modal.reset();
      document.getElementById('habit-journal').value = "";
      document.getElementById('journal-list').innerHTML = "";
      document.getElementById('alarm-status-label').textContent = "Off";
      document.getElementById('alarm-status-label').classList.add('alarm-off');
      document.getElementById('alarm-toggle-btn').classList.remove('alarmed');
      if (!editing) {
        modalTitle.textContent = "Add Habit";
        renderIconPicker(ICONS[0]);
        document.getElementById('habit-emoji').value = ICONS[0];
        document.getElementById('habit-color').value = getRandomColor();
        document.getElementById('habit-importance').value = "medium";
        document.getElementById('habit-frequency').value = "daily";
        document.getElementById('habit-target').value = 1;
        document.getElementById('habit-alarm').value = "";
        document.getElementById('habit-template').value = "";
        document.getElementById('goal-label').textContent = "per day";
        document.getElementById('custom-period-row').style.display = "none";
        document.getElementById('habit-custom-period').value = "";
        editingHabitId = null;
      } else {
        modalTitle.textContent = "Edit Habit";
        renderIconPicker(habit.emoji);
        document.getElementById('habit-emoji').value = habit.emoji;
        document.getElementById('habit-title').value = habit.title;
        document.getElementById('habit-color').value = habit.color || getRandomColor();
        document.getElementById('habit-importance').value = habit.importance||"medium";
        document.getElementById('habit-frequency').value = habit.frequency;
        document.getElementById('habit-target').value = habit.target;
        document.getElementById('habit-alarm').value = habit.alarm||"";
        if (habit.alarm && habit.alarmActive) {
          document.getElementById('alarm-status-label').textContent = "On";
          document.getElementById('alarm-status-label').classList.remove('alarm-off');
          document.getElementById('alarm-toggle-btn').classList.add('alarmed');
        }
        document.getElementById('habit-template').value = "";
        document.getElementById('goal-label').textContent = habit.frequency==="daily"?"per day":habit.frequency==="weekly"?"per week":"per period";
        if (habit.frequency === "custom") {
          document.getElementById('custom-period-row').style.display = "";
          document.getElementById('habit-custom-period').value = habit.customPeriod || "";
        } else {
          document.getElementById('custom-period-row').style.display = "none";
          document.getElementById('habit-custom-period').value = "";
        }
        editingHabitId = habit.id;
        if (habit.journal) {
          let today = todayStr();
          let j = habit.journal[today]||"";
          document.getElementById('journal-list').innerHTML = Object.entries(habit.journal)
            .reverse().map(([d, v])=>`<div><b>${d}:</b> ${v}</div>`).join("");
          document.getElementById('habit-journal').value = j;
        }
      }
    }
    function closeHabitModal() {
      modalBg.classList.remove('active');
      editingHabitId = null;
    }

    // ====== HABIT CRUD ======
    modal.onsubmit = function(e) {
      e.preventDefault();
      const emoji = document.getElementById('habit-emoji').value.trim() || ICONS[0];
      const title = document.getElementById('habit-title').value.trim();
      const color = document.getElementById('habit-color').value;
      const importance = document.getElementById('habit-importance').value;
      const frequency = document.getElementById('habit-frequency').value;
      const target = Math.max(1, +document.getElementById('habit-target').value);
      const alarm = document.getElementById('habit-alarm').value;
      const alarmActive = (alarm && document.getElementById('alarm-status-label').textContent === "On");
      let customPeriod = "";
      if (frequency === "custom") {
        customPeriod = document.getElementById('habit-custom-period').value.trim();
      }
      let journalText = document.getElementById('habit-journal').value.trim();
      let habits = getHabits();
      let journal = {};
      if (editingHabitId) {
        habits = habits.map(h => {
          if (h.id===editingHabitId) {
            if (!h.journal) h.journal = {};
            if (journalText) h.journal[todayStr()] = journalText;
            return {...h, emoji, title, color, frequency, target, importance, alarm, alarmActive, customPeriod, journal: h.journal};
          }
          return h;
        });
        showHint("Habit updated!");
      } else {
        const id = "h" + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
        if (journalText) journal[todayStr()] = journalText;
        habits.push({
          id, emoji, title, color, frequency, target, importance, alarm, alarmActive, customPeriod,
          history: {}, // dateStr: count
          created: todayStr(),
          journal
        });
        showHint("Habit added!");
      }
      saveHabits(habits);
      closeHabitModal();
      renderHabits();
      reloadAlarms();
    };

    // Alarm toggle
    document.getElementById('alarm-toggle-btn').onclick = function() {
      let label = document.getElementById('alarm-status-label');
      if (label.textContent === "Off") {
        label.textContent = "On";
        label.classList.remove('alarm-off');
        this.classList.add('alarmed');
      } else {
        label.textContent = "Off";
        label.classList.add('alarm-off');
        this.classList.remove('alarmed');
      }
    };

    // ====== RENDER HABITS ======
    function renderHabits() {
      const habits = getHabits();
      const list = document.getElementById('habits-list');
      list.innerHTML = habits.length ? "" : "<p style='color:#888;font-size:1.13em;text-align:center;width:100vw'>No habits yet. Add your first!</p>";
      habits.forEach(habit => {
        const card = document.createElement('div');
        card.className = "habit-card";
        if (habitStreak(habit) > 0) card.dataset.streak = "1";
        // ========== HEADER
        const header = document.createElement('div');
        header.className = "habit-header-row";
        header.innerHTML = `
          <div class="habit-title">
            <span class="habit-emoji" style="background:${habit.color}22;border-color:${habit.color}">${habit.emoji}</span>
            ${habit.title}
            <span class="habit-target">Goal: ${habit.target} ${habit.frequency==="daily"?"per day":habit.frequency==="weekly"?"per week":habit.customPeriod?("("+habit.customPeriod+")"):"per period"}</span>
            ${getImportanceBadge(habit.importance)}
          </div>
          <div class="habit-actions">
            <button class="habit-action-btn" title="View Schedule"><i class="fa-solid fa-calendar-days"></i></button>
            <button class="habit-action-btn" title="Edit"><i class="fa-solid fa-pen"></i></button>
            <button class="habit-action-btn" title="Delete"><i class="fa-solid fa-trash"></i></button>
            <button class="habit-action-btn" title="Share"><i class="fa-solid fa-share-nodes"></i></button>
          </div>
        `;
        card.append(header);

        // ========== HABIT CALENDAR (past, today, future)
        const calendar = document.createElement('div');
        calendar.className = "habit-calendar";
        const days = getCalendarDays(habit);
        const today = todayStr();
        for (let d of days) {
          const btn = document.createElement('div');
          btn.className = "calendar-day";
          let todayD = new Date(today);
          let dD = new Date(d.key);

          if (dD > todayD) btn.classList.add("future");
          if (d.key === today) btn.classList.add('today');
          if ((habit.history||{})[d.key]) btn.classList.add('completed');
          if (dD < todayD && !btn.classList.contains("completed")) btn.classList.add("missed");

          btn.title = d.displayLong + (btn.classList.contains('completed') ? " (completed)" :
                        btn.classList.contains('missed') ? " (missed)" :
                        btn.classList.contains('future') ? " (future)" : "");

          if (btn.classList.contains('completed')) btn.innerHTML = '<i class="fa fa-check"></i>';
          else if (btn.classList.contains('missed')) btn.innerHTML = '<i class="fa fa-xmark"></i>';
          else if (btn.classList.contains('future')) btn.innerHTML = '<i class="fa fa-clock"></i>';
          else btn.textContent = d.display;

          btn.onclick = ()=>{
            if (btn.classList.contains("future")) return;
            toggleHabitDone(habit.id, d.key);
          };
          calendar.append(btn);
        }
        card.append(calendar);

        const scheduleBtn = header.querySelectorAll('.habit-action-btn')[0];
        scheduleBtn.onclick = ()=> openScheduleModal(habit);

        // ========== STATS
        const stats = document.createElement('div');
        stats.className = "habit-stats";
        let streak = habitStreak(habit);
        let maxStreak = habitMaxStreak(habit);
        let completions = Object.values(habit.history||{}).filter(Boolean).length;
        let thisWeek = habitCompletionsThis(habit, "week");
        let thisMonth = habitCompletionsThis(habit, "month");
        stats.innerHTML = `
          <span class="stat" title="Current Streak"><i class="fa-solid fa-fire"></i> ${streak} day streak</span>
          <span class="stat" title="Longest Streak"><i class="fa-solid fa-flag-checkered"></i> Max: ${maxStreak}</span>
          <span class="stat" title="This week"><i class="fa-solid fa-bolt"></i> ${thisWeek} this week</span>
          <span class="stat" title="This month"><i class="fa-solid fa-check-circle"></i> ${thisMonth} this month</span>
        `;
        card.append(stats);

        // ========== PROGRESS BAR
        const prog = document.createElement('div');
        prog.className = "habit-progress-bar";
        let pct = Math.min(100, Math.round(100 * habitProgress(habit)));
        prog.innerHTML = `<div class="progress-bar-inner" style="width:${pct}%"></div><span class="progress-bar-label">${pct}%</span>`;
        card.append(prog);

        const [, editBtn, delBtn, shareBtn] = header.querySelectorAll('.habit-action-btn');
        editBtn.onclick = () => openHabitModal(true, habit);
        delBtn.onclick = () => {
          if (confirm("Delete this habit?")) {
            let habits = getHabits().filter(h => h.id !== habit.id);
            saveHabits(habits);
            renderHabits();
            showHint("Habit deleted");
            reloadAlarms();
          }
        };
        shareBtn.onclick = () => {
          const text = `My habit: ${habit.emoji} "${habit.title}"\nStreak: ${streak} days\nCompletions: ${completions}\nTry it out: ${location.href}`;
          if (navigator.share) {
            navigator.share({title: "Habit Progress", text})
          } else {
            navigator.clipboard.writeText(text);
            showHint("Habit progress copied!");
          }
        };
        list.append(card);
      });
    }
    function getCalendarDays(habit) {
      const days = [];
      const now = new Date();
      if (habit.frequency === "daily" || !habit.frequency) {
        for (let i = 6; i >= 0; --i) {
          let d = new Date();
          d.setDate(now.getDate() - i);
          days.push({
            key: d.toISOString().slice(0,10),
            display: d.toLocaleDateString(undefined,{weekday:'short'}).slice(0,2),
            displayLong: d.toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric'})
          });
        }
      } else if (habit.frequency === "weekly") {
        for (let i = 3; i >= 0; --i) {
          let d = new Date(getWeekStart(now));
          d.setDate(d.getDate() - i*7);
          days.push({
            key: d.toISOString().slice(0,10),
            display: "Wk " + getWeekNumber(d),
            displayLong: "Week of "+d.toLocaleDateString(undefined,{month:'short',day:'numeric'})
          });
        }
      } else { // custom: show 7 days as fallback
        for (let i = 6; i >= 0; --i) {
          let d = new Date();
          d.setDate(now.getDate() - i);
          days.push({
            key: d.toISOString().slice(0,10),
            display: d.toLocaleDateString(undefined,{weekday:'short'}).slice(0,2),
            displayLong: d.toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric'})
          });
        }
      }
      return days;
    }
    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return weekNo;
    }
    function toggleHabitDone(habitId, dateKey) {
      let habits = getHabits();
      habits = habits.map(h => {
        if (h.id !== habitId) return h;
        if (!h.history) h.history = {};
        h.history[dateKey] = !h.history[dateKey];
        return h;
      });
      saveHabits(habits);
      renderHabits();
    }
    // Stats
    function habitStreak(habit) {
      let keys = Object.keys(habit.history||{}).sort().reverse();
      if (!keys.length) return 0;
      let streak = 0;
      let d = new Date();
      let step = habit.frequency==="daily"?1:7;
      for (let i=0; i<keys.length; ++i) {
        let key = d.toISOString().slice(0,10);
        if (habit.history[key]) { streak++; }
        else break;
        if (habit.frequency==="daily") d.setDate(d.getDate()-1);
        else d.setDate(d.getDate()-7);
      }
      return streak;
    }
    function habitMaxStreak(habit) {
      let keys = Object.keys(habit.history||{}).sort();
      if (!keys.length) return 0;
      let streak = 0, max = 0;
      let lastDate = null;
      let step = habit.frequency==="daily"?1:7;
      for (let key of keys) {
        if (!habit.history[key]) { streak = 0; lastDate = null; continue; }
        let d = new Date(key);
        if (lastDate) {
          let diff = Math.round((d-lastDate)/(1000*60*60*24));
          if (diff===step) streak++;
          else streak = 1;
        } else streak = 1;
        max = Math.max(max, streak);
        lastDate = d;
      }
      return max;
    }
    function habitCompletionsThis(habit, period) {
      const now = new Date();
      let count = 0;
      for (let key in (habit.history||{})) {
        if (!habit.history[key]) continue;
        let d = new Date(key);
        if (period==="week") {
          let ws = getWeekStart(now), we = new Date(ws); we.setDate(ws.getDate()+6);
          if (d >= ws && d <= we) count++;
        } else if (period==="month") {
          if (d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth()) count++;
        }
      }
      return count;
    }
    function habitProgress(habit) {
      if (habit.frequency==="daily") {
        let weekDays = getCalendarDays(habit);
        let done = weekDays.filter(d=>habit.history&&habit.history[d.key]).length;
        return done / weekDays.length;
      } else if (habit.frequency==="weekly") {
        let weeks = getCalendarDays(habit);
        let done = weeks.filter(d=>habit.history&&habit.history[d.key]).length;
        return done / weeks.length;
      } else {
        let weekDays = getCalendarDays(habit);
        let done = weekDays.filter(d=>habit.history&&habit.history[d.key]).length;
        return done / weekDays.length;
      }
    }

    // ====== SCHEDULE MODAL ======
    const scheduleModalBg = document.getElementById('schedule-modal-bg');
    const scheduleModal = document.getElementById('schedule-modal');
    const scheduleCloseBtn = document.getElementById('schedule-close-btn');
    scheduleCloseBtn.onclick = ()=> scheduleModalBg.classList.remove('active');
    scheduleModalBg.onclick = e=>{ if(e.target===scheduleModalBg)scheduleModalBg.classList.remove('active'); };

    function openScheduleModal(habit) {
      scheduleModalBg.classList.add('active');
      document.getElementById('schedule-title').textContent = "Schedule: " + habit.title;
      const calDiv = document.getElementById('schedule-calendar');
      calDiv.innerHTML = "";
      // Show 35 days (5 weeks) ending today
      const days = [];
      const now = new Date();
      for(let i=34;i>=-7;--i){
        let d = new Date();
        d.setDate(now.getDate()-i);
        days.push({
          key: d.toISOString().slice(0,10),
          display: d.getDate(),
          displayLong: d.toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric'})
        });
      }
      days.forEach(d=>{
        const btn = document.createElement('div');
        btn.className = "calendar-small-day";
        let todayD = new Date(todayStr());
        let dD = new Date(d.key);

        if (dD > todayD) btn.classList.add("future");
        if (d.key === todayStr()) btn.classList.add('today');
        if ((habit.history||{})[d.key]) btn.classList.add('completed');
        if (dD < todayD && !btn.classList.contains("completed")) btn.classList.add("missed");

        btn.title = d.displayLong + (btn.classList.contains('completed') ? " (completed)" :
                      btn.classList.contains('missed') ? " (missed)" :
                      btn.classList.contains('future') ? " (future)" : "");

        if (btn.classList.contains('completed')) btn.innerHTML = '<i class="fa fa-check"></i>';
        else if (btn.classList.contains('missed')) btn.innerHTML = '<i class="fa fa-xmark"></i>';
        else if (btn.classList.contains('future')) btn.innerHTML = '<i class="fa fa-clock"></i>';
        else btn.textContent = d.display;

        btn.onclick = ()=>{
          if (btn.classList.contains("future")) return;
          toggleHabitDone(habit.id, d.key);
          openScheduleModal(habit); // re-render
        };
        calDiv.appendChild(btn);
      });
    }

    // ====== ALARM LOGIC ======
    let alarmAudio = null;
    function playAlarm() {
      if (!alarmAudio) {
        alarmAudio = new Audio("https://cdn.pixabay.com/audio/2022/10/16/audio_12d4b6b7c8.mp3"); // royalty-free bell sound, change as needed
        alarmAudio.loop = true;
      }
      alarmAudio.currentTime = 0;
      alarmAudio.play();
    }
    function stopAlarm() {
      if (alarmAudio) alarmAudio.pause();
    }
    function ringAlarm(habit) {
      playAlarm();
      document.getElementById('alarm-modal-title').innerHTML = `⏰ Time for your habit!`;
      document.getElementById('alarm-modal-body').innerHTML = `<b>${habit.emoji} ${habit.title}</b><br>It's time to do your habit.<br><small>(${habit.alarm})</small>`;
      document.getElementById('alarm-modal-bg').classList.add('active');
      document.getElementById('alarm-stop-btn').onclick = closeAlarmModal;
      document.getElementById('alarm-close-btn').onclick = closeAlarmModal;
    }
    function closeAlarmModal() {
      stopAlarm();
      document.getElementById('alarm-modal-bg').classList.remove('active');
    }
    // Alarm check
    function reloadAlarms() {
      clearInterval(window._habitAlarmInterval);
      window._habitAlarmInterval = setInterval(()=>{
        let habits = getHabits();
        const now = new Date();
        const nowH = now.getHours(), nowM = now.getMinutes();
        for (let habit of habits) {
          if (habit.alarm && habit.alarmActive) {
            let [h,m] = habit.alarm.split(':').map(Number);
            if (h === nowH && m === nowM) {
              if (!window._alarmedToday) window._alarmedToday = {};
              let today = todayStr();
              if (window._alarmedToday[habit.id] !== today) {
                ringAlarm(habit);
                window._alarmedToday[habit.id] = today;
              }
            }
          }
        }
        // Reset at 00:01
        if (nowH === 0 && nowM === 1) window._alarmedToday = {};
      }, 1000 * 10); // every 10s for reliability
    }

    // ====== ANALYTICS ======
    function openAnalytics() {
      if (!window.analyticsModal) {
        window.analyticsModal = document.createElement("div");
        window.analyticsModal.className = "analytics-modal-bg active";
        window.analyticsModal.style.display = "flex";
        window.analyticsModal.innerHTML = `
          <div class="analytics-modal" style="background:#192041;border-radius:1.3em;padding:1.6em 2.5em 1.4em 2.5em;box-shadow:0 4px 16px #14b8a633;min-width:350px;max-width:99vw;max-height:99vh;position:relative;display:flex;flex-direction:column;gap:1.2em;z-index:220;animation:fadeIn 0.23s;color:#dbeafe;overflow:auto;">
            <button type="button" class="modal-close" id="analytics-close-btn"><i class="fa-solid fa-times"></i></button>
            <h2 style="color:var(--accent);">Habit Analytics</h2>
            <canvas id="analytics-canvas" width="380" height="260" style="margin-bottom:1.5em"></canvas>
            <div id="analytics-data" style="font-size:1.14em"></div>
          </div>`;
        document.body.appendChild(window.analyticsModal);
        window.analyticsModal.querySelector(".modal-close").onclick = ()=>window.analyticsModal.remove();
        window.analyticsModal.onclick = e=>{if(e.target===window.analyticsModal)window.analyticsModal.remove();};
      }
      renderAnalytics();
    }
    document.getElementById('analytics-btn').onclick = openAnalytics;
    function renderAnalytics() {
      let habits = getHabits();
      let canvas = document.getElementById('analytics-canvas');
      let ctx = canvas.getContext('2d');
      let data = habits.map(h=>Object.values(h.history||{}).filter(Boolean).length);
      let labels = habits.map(h=>h.title);
      if(window.analyticsChart)window.analyticsChart.destroy();
      window.analyticsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Completions',
            data,
            backgroundColor: labels.map((_,i)=>habits[i].color||"#64ffda"),
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {ticks:{color:'#64ffda'}},
            y: {beginAtZero:true,ticks:{color:'#64ffda'}}
          }
        }
      });
      let total = data.reduce((a,b)=>a+b,0);
      let max = Math.max(...data,0);
      let longest = Math.max(...habits.map(h=>habitMaxStreak(h)),0);
      document.getElementById('analytics-data').innerHTML =
        `<b>Total completions:</b> ${total}<br>
         <b>Most completed habit:</b> ${labels[data.indexOf(max)]||"-"}<br>
         <b>Longest streak (any habit):</b> ${longest} days`;
    }

    // ====== SETTINGS, IMPORT/EXPORT ======
    const settingsModalBg = document.getElementById('settings-modal-bg');
    document.getElementById('open-settings-btn').onclick = ()=>settingsModalBg.classList.add('active');
    document.getElementById('settings-close-btn').onclick = ()=>settingsModalBg.classList.remove('active');
    settingsModalBg.onclick = e=>{if(e.target===settingsModalBg)settingsModalBg.classList.remove('active');};
    document.getElementById('export-btn').onclick = function() {
      let data = localStorage.getItem('habitflow_habits');
      let blob = new Blob([data],{type:'application/json'});
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url;
      a.download = 'habits-export.json';
      a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById('import-btn').onclick = function() {
      document.getElementById('import-file').click();
    };
    document.getElementById('import-file').onchange = function(e) {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(ev) {
        try {
          let arr = JSON.parse(ev.target.result);
          if (Array.isArray(arr)) {
            saveHabits(arr);
            renderHabits();
            showHint("Data imported!");
            reloadAlarms();
          }
        } catch(e) { showHint("Invalid file!"); }
      };
      reader.readAsText(file);
    };

    // ====== INIT ======
    if (localStorage.getItem('theme')==='light') enableLightTheme();
    else enableDarkTheme();
    renderHabits();
    reloadAlarms();
  </script>
</body>
</html>
