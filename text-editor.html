<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RQR9BDLJ26"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-RQR9BDLJ26');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Taskflows Ultimate Editor</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <link
    href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Anton&family=Bitter&family=Cabin&family=Dancing+Script&family=Dosis&family=Fira+Sans&family=Inconsolata&family=Inter:wght@300;400;500;600;700&family=Josefin+Sans&family=Kanit&family=Lato&family=Lobster&family=Lora&family=Merriweather&family=Montserrat&family=Mukta&family=Nunito&family=Open+Sans&family=Oswald&family=Oxygen&family=Pacifico&family=Playfair+Display&family=Poppins&family=Quicksand&family=Raleway&family=Righteous&family=Roboto&family=Rubik&family=Shadows+Into+Light&family=Source+Sans+Pro&family=Ubuntu&family=Varela+Round&family=Work+Sans&display=swap"
    rel="stylesheet">

  <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>

  <style>
    /* --- THEME VARIABLES --- */
    :root {
      --bg-body: #f3f4f6;
      --bg-sidebar: #ffffff;
      --bg-card: #ffffff;
      --bg-hover: #f3f4f6;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-color: #e5e7eb;
      --accent: #6366f1;
      --scrollbar-track: #f1f1f1;
      --scrollbar-thumb: #c1c1c1;
      --editor-toolbar: #f9fafb;
      --input-bg: #ffffff;
    }

    [data-theme="dark"] {
      --bg-body: #050505;
      --bg-sidebar: #0a0a0a;
      --bg-card: #121212;
      --bg-hover: #1a1a1a;
      --text-main: #ffffff;
      --text-muted: #a3a3a3;
      --border-color: #262626;
      --accent: #6366f1;
      --scrollbar-track: #0a0a0a;
      --scrollbar-thumb: #333;
      --editor-toolbar: #1a1a1a;
      --input-bg: #1a1a1a;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- SIDEBAR --- */
    #sidebar-wrapper {
      width: 260px;
      background-color: var(--bg-sidebar);
      transition: margin-left 0.3s ease, background-color 0.3s;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      padding: 24px 16px;
    }

    #sidebar-wrapper.toggled {
      margin-left: -260px;
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px;
      padding-left: 8px;
    }

    .sidebar-menu {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-grow: 1;
      overflow-y: auto;
    }

    .sidebar-link {
      padding: 10px 16px;
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      font-weight: 500;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      text-decoration: none;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .sidebar-link:hover {
      background-color: var(--bg-hover);
      color: var(--text-main);
      border-color: var(--border-color);
    }

    .sidebar-link.active {
      background-color: var(--accent);
      color: white !important;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .sidebar-link.active i {
      color: white !important;
    }

    .sidebar-link i {
      font-size: 1.3rem;
      margin-right: 12px;
      color: var(--text-muted);
      transition: color 0.2s;
    }

    .sidebar-section-header {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      margin-top: 24px;
      margin-bottom: 12px;
      padding-left: 16px;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 20px;
    }

    /* --- EDITOR TOOLBAR --- */
    .ql-toolbar.ql-snow {
      background-color: var(--editor-toolbar);
      border-color: var(--border-color);
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      padding: 8px 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    .ql-snow .ql-picker.ql-font {
      width: 160px;
    }

    .ql-snow .ql-picker-label {
      color: var(--text-main);
      outline: none;
    }

    .ql-snow .ql-picker-options {
      background-color: var(--bg-card);
      border-color: var(--border-color);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      max-height: 300px;
      overflow-y: auto;
    }

    .ql-snow .ql-picker-item {
      color: var(--text-main);
      padding: 5px 10px;
    }

    .ql-snow .ql-picker-item:hover {
      background-color: var(--bg-hover);
      color: var(--accent);
    }

    .size-control-wrapper {
      display: flex;
      align-items: center;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
    }

    .btn-size-adjust {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 0 8px;
      height: 30px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
    }

    .btn-size-adjust:hover {
      background: var(--bg-hover);
      color: var(--text-main);
    }

    #custom-font-size {
      background-color: transparent;
      border: none;
      border-left: 1px solid var(--border-color);
      border-right: 1px solid var(--border-color);
      color: var(--text-main);
      height: 30px;
      width: 40px;
      font-size: 14px;
      text-align: center;
      padding: 0;
      -moz-appearance: textfield;
    }

    #custom-font-size::-webkit-outer-spin-button,
    #custom-font-size::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    #custom-font-size:focus {
      outline: none;
      background-color: var(--bg-hover);
    }

    #editor-container {
      background-color: var(--bg-card);
      color: var(--text-main);
      border-color: var(--border-color);
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      font-size: 16px;
      min-height: 400px;
    }

    .ql-editor {
      color: var(--text-main) !important;
    }

    .ql-editor.ql-blank::before {
      color: var(--text-muted);
      font-style: normal;
    }

    [data-theme="dark"] .ql-snow .ql-stroke {
      stroke: #e5e5e5;
    }

    [data-theme="dark"] .ql-snow .ql-fill {
      fill: #e5e5e5;
    }

    [data-theme="dark"] .ql-snow .ql-picker {
      color: #e5e5e5;
    }

    .btn-custom {
      background-color: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-muted);
      transition: 0.2s;
    }

    .btn-custom:hover {
      background-color: var(--bg-hover);
      color: var(--text-main);
    }

    #doc-title-input {
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-main);
      font-weight: 700;
      font-size: 1.25rem;
      padding: 2px 8px;
      border-radius: 6px;
      transition: 0.2s;
      width: 100%;
    }

    #doc-title-input:hover {
      border-color: var(--border-color);
      background: var(--bg-hover);
    }

    #doc-title-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .doc-item {
      padding: 10px;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s;
      position: relative;
    }

    .doc-item:hover {
      background-color: var(--bg-hover);
    }

    .doc-item.active-doc {
      background-color: var(--bg-hover);
      border-left: 3px solid var(--accent);
    }

    .dropdown-menu {
      background-color: var(--bg-card);
      border-color: var(--border-color);
    }

    .dropdown-item {
      color: var(--text-main);
    }

    .dropdown-item:hover {
      background-color: var(--bg-hover);
      color: var(--text-main);
    }

    /* --- MOBILE OPTIMIZATIONS --- */
    @media (max-width: 768px) {
      #sidebar-wrapper {
        position: fixed;
        height: 100%;
        margin-left: -260px;
      }

      #sidebar-wrapper.mobile-show {
        margin-left: 0;
      }

      .mobile-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .mobile-overlay.show {
        display: block;
      }

      /* Scrollable Toolbar for Mobile */
      .ql-toolbar.ql-snow {
        flex-wrap: nowrap !important;
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 5px;
        -webkit-overflow-scrolling: touch;
      }

      /* Hide Scrollbar in toolbar */
      .ql-toolbar.ql-snow::-webkit-scrollbar {
        height: 4px;
      }

      .ql-formats {
        display: inline-flex;
        margin-right: 15px !important;
      }

      /* Better input sizing */
      #doc-title-input {
        font-size: 1rem;
        padding: 4px;
      }

      /* Hide font picker on extremely small screens if needed, 
         or just let it scroll */
      .ql-snow .ql-picker.ql-font {
        width: 110px;
      }

      /* Adjust Editor Height for Mobile Keyboards */
      #editor-container {
        min-height: 50vh;
      }

      .mobile-padding-fix {
        padding: 0.75rem !important;
      }
    }

    /* Offcanvas Styling */
    .offcanvas {
      background-color: var(--bg-sidebar);
      color: var(--text-main);
    }

    .offcanvas-header .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
    }

    [data-theme="light"] .offcanvas-header .btn-close {
      filter: none;
    }
  </style>
</head>

<body>

  <div class="d-flex h-100" id="wrapper">

    <div class="mobile-overlay" id="mobileOverlay"></div>

    <div id="sidebar-wrapper">
      <div class="sidebar-brand">
        <i class="ph-fill ph-diamonds-four fs-4" style="color: var(--accent);"></i>
        <span class="fs-5 fw-bold" style="color: var(--text-main);">Taskflows</span>
      </div>

      <div class="sidebar-menu">
        <a href="dashboard.html" class="sidebar-link"><i class="ph ph-squares-four"></i> Dashboard</a>
        

        <div class="sidebar-section-header">WORKSPACE</div>
        <a href="text-editor.html" class="sidebar-link active"><i class="ph ph-file-text"></i> Text Editor</a>
        <a href="to-do-lists.html" class="sidebar-link"><i class="ph ph-list-checks"></i> To-Do Lists</a>
        <a href="notes.html" class="sidebar-link"><i class="ph ph-note"></i> Notes</a>
        <a href="whiteboard.html" class="sidebar-link"><i class="ph ph-scribble-loop"></i> Whiteboard</a>

        <div class="sidebar-section-header">PERSONAL</div>
        <a href="lists.html" class="sidebar-link"><i class="ph ph-list"></i> Lists</a>
        <a href="journal.html" class="sidebar-link"><i class="ph ph-book-bookmark"></i> Journal</a>
        <a href="quicknotes.html" class="sidebar-link"><i class="ph ph-bolt"></i> Quick Notes</a>
      </div>

      <div class="sidebar-footer">
        <a href="edit_profile.html" class="sidebar-link"><i class="ph ph-user-circle"></i> Edit Profile</a>
      </div>
    </div>

    <div id="page-content-wrapper" class="w-100 d-flex flex-column">

      <nav class="navbar navbar-expand-lg border-bottom px-3 py-3"
        style="background-color: var(--bg-body); border-color: var(--border-color) !important;">
        <div class="container-fluid p-0">

          <div class="d-flex align-items-center me-2">
            <button class="btn btn-custom me-2" id="menu-toggle"><i class="ph ph-list fs-5"></i></button>
            <button class="btn btn-custom d-md-none" type="button" data-bs-toggle="offcanvas"
              data-bs-target="#mobileDocs" aria-controls="mobileDocs">
              <i class="ph ph-folder fs-5"></i>
            </button>
          </div>

          <div class="d-flex flex-column justify-content-center flex-grow-1 me-2 overflow-hidden">
            <input type="text" id="doc-title-input" value="Untitled Document" class="mb-0">
            <small class="text-truncate" style="color: var(--text-muted); padding-left: 8px;">Workspace / Editor</small>
          </div>

          <div class="ms-auto d-flex align-items-center gap-2">
            <button class="btn btn-custom rounded-circle p-2" id="theme-toggle" title="Toggle Theme">
              <i class="ph ph-moon fs-5" id="theme-icon"></i>
            </button>

            <button class="btn btn-primary d-md-block" style="background-color: var(--accent); border:none;"
              onclick="triggerSave()">
              <span class="d-none d-md-inline"><i class="ph ph-floppy-disk me-1"></i> Save</span>
              <span class="d-md-none"><i class="ph ph-floppy-disk"></i></span>
            </button>
          </div>
        </div>
      </nav>

      <div class="container-fluid p-0 flex-grow-1 d-flex flex-column overflow-hidden">
        <div class="row h-100 g-0">

          <div class="col-md-3 col-lg-2 d-none d-md-flex flex-column border-end p-0"
            style="background-color: var(--bg-sidebar); border-color: var(--border-color) !important;">
            <div class="p-3 d-flex justify-content-between align-items-center">
              <span class="fw-bold" style="color: var(--text-muted);">DOCUMENTS</span>
              <button class="btn btn-sm btn-link text-decoration-none p-0 fw-bold" style="color: var(--accent);"
                onclick="createNewDoc()">+ New</button>
            </div>
            <div class="px-3 pb-3">
              <input type="text" id="search-docs" class="form-control form-control-sm" placeholder="Filter..."
                style="background-color: var(--bg-card); color: var(--text-main); border-color: var(--border-color);">
            </div>
            <div id="document-list" class="flex-grow-1 overflow-auto px-2 pb-5"></div>
          </div>

          <div class="col-12 col-md-9 col-lg-10 p-3 p-md-4 mobile-padding-fix d-flex flex-column h-100 overflow-auto"
            style="background-color: var(--bg-body);">

            <div class="d-flex justify-content-between mb-2">
              <div class="btn-group">
                <button class="btn btn-sm btn-custom" onclick="window.print()"><i class="ph ph-printer"></i>
                  <span class="d-none d-md-inline">Print</span></button>
                <button class="btn btn-sm btn-custom"><i class="ph ph-file-pdf"></i> <span
                    class="d-none d-md-inline">Export</span></button>
              </div>
              <small id="status-indicator" class="text-success d-none"><i class="ph ph-check"></i> <span
                  class="d-none d-md-inline">Changes saved</span><span class="d-md-none">Saved</span></small>
            </div>

            <div class="flex-grow-1 d-flex flex-column shadow-sm rounded-3 overflow-hidden">

              <div id="toolbar-container">
                <select class="ql-font"></select>

                <span class="border-end mx-2"
                  style="border-color: var(--border-color) !important; height: 20px;"></span>

                <div class="size-control-wrapper me-2">
                  <button class="btn-size-adjust" onclick="changeSize(-2)" title="Decrease Size"><i
                      class="ph ph-minus"></i></button>
                  <input type="number" id="custom-font-size" value="16" min="8" max="200" title="Font Size">
                  <button class="btn-size-adjust" onclick="changeSize(2)" title="Increase Size"><i
                      class="ph ph-plus"></i></button>
                </div>

                <span class="ql-formats">
                  <button class="ql-bold"></button>
                  <button class="ql-italic"></button>
                  <button class="ql-underline"></button>
                  <button class="ql-strike"></button>
                </span>
                <span class="ql-formats">
                  <select class="ql-color"></select>
                  <select class="ql-background"></select>
                </span>
                <span class="ql-formats">
                  <button class="ql-list" value="ordered"></button>
                  <button class="ql-list" value="bullet"></button>
                  <button class="ql-align" value=""></button>
                  <button class="ql-align" value="center"></button>
                </span>
                <span class="ql-formats">
                  <button class="ql-image"></button>
                </span>
                <span class="ql-formats">
                  <button class="ql-clean"></button>
                </span>
              </div>

              <div id="editor-container" class="flex-grow-1 border-0"></div>
            </div>

            <div class="mt-2 d-flex justify-content-between" style="color: var(--text-muted); font-size: 0.85rem;">
              <span id="word-count">0 Words | 0 Chars</span>
              <span id="reading-time">~0 min</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileDocs" aria-labelledby="mobileDocsLabel">
    <div class="offcanvas-header border-bottom" style="border-color: var(--border-color) !important;">
      <h5 class="offcanvas-title fw-bold" id="mobileDocsLabel">Documents</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column p-0">
      <div class="p-3">
        <button class="btn btn-primary w-100 mb-3" style="background-color: var(--accent); border:none;"
          onclick="createNewDoc(); document.querySelector('[data-bs-dismiss=offcanvas]').click();">+ New
          Document</button>
        <input type="text" id="search-docs-mobile" class="form-control form-control-sm" placeholder="Filter..."
          style="background-color: var(--bg-card); color: var(--text-main); border-color: var(--border-color);">
      </div>
      <div id="document-list-mobile" class="flex-grow-1 overflow-auto px-3">
      </div>
    </div>
  </div>

  <input type="file" id="image-upload" class="d-none" accept="image/*">

  <style id="font-preview-styles"></style>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <script>
    // --- 1. CONFIG: FONTS & SIZES ---

    // We import the Style attributors to handle arbitrary values (e.g. "23px", "font-family: Roboto")
    var FontAttributor = Quill.import('attributors/style/font');
    var SizeAttributor = Quill.import('attributors/style/size');

    const fontNames = [
      'Inter', 'Roboto', 'Open Sans', 'Lato', 'Montserrat', 'Oswald',
      'Source Sans Pro', 'Raleway', 'Merriweather',
      'Nunito', 'Playfair Display', 'Ubuntu', 'Rubik', 'Poppins',
      'Kanit', 'Fira Sans', 'Mukta', 'Inconsolata', 'Bitter',
      'Dosis', 'Josefin Sans', 'Anton', 'Cabin',
      'Pacifico', 'Lobster', 'Shadows Into Light', 'Dancing Script',
      'Abril Fatface', 'Righteous', 'Varela Round'
    ];

    // Whitelist setup
    FontAttributor.whitelist = fontNames;
    Quill.register(FontAttributor, true);
    Quill.register(SizeAttributor, true);

    // Populate the dropdown <option> tags so Quill knows what to render
    const fontSelect = document.querySelector('.ql-font');
    fontNames.forEach(font => {
      const option = document.createElement('option');
      option.value = font;
      option.innerText = font;
      if (font === 'Inter') option.selected = true;
      fontSelect.appendChild(option);
    });

    // --- 2. DYNAMIC CSS FOR FONT PREVIEWS ---
    const styleTag = document.getElementById('font-preview-styles');
    let cssRules = "";
    fontNames.forEach(font => {
      cssRules += `
            .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="${font}"]::before {
                content: "${font}";
                font-family: "${font}", sans-serif;
            }
            .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="${font}"]::before {
                content: "${font}";
                font-family: "${font}", sans-serif;
            }
        `;
    });
    styleTag.innerHTML = cssRules;


    // --- 3. INIT QUILL ---
    var quill = new Quill('#editor-container', {
      theme: 'snow',
      modules: {
        toolbar: {
          container: '#toolbar-container',
          handlers: {
            image: imageHandler
          }
        }
      },
      placeholder: 'Start writing...',
    });


    // --- 4. FONT SIZE LOGIC (NUMBER + BUTTONS) ---
    const sizeInput = document.getElementById('custom-font-size');

    function changeSize(amount) {
      let current = parseInt(sizeInput.value) || 16;
      let newSize = current + amount;
      if (newSize < 8) newSize = 8;
      if (newSize > 200) newSize = 200;

      sizeInput.value = newSize;
      applySize(newSize);
    }

    function applySize(val) {
      quill.format('size', val + 'px');
      quill.focus();
    }

    sizeInput.addEventListener('change', function () {
      applySize(this.value);
    });

    quill.on('selection-change', function (range, oldRange, source) {
      if (range) {
        let format = quill.getFormat(range);
        if (format.size) {
          sizeInput.value = parseInt(format.size);
        } else {
          sizeInput.value = 16;
        }
      }
    });


    // --- 5. APP STATE ---
    let documents = [];
    let activeDocId = null;

    function initApp() {
      const storedDocs = localStorage.getItem('tf_documents');
      const storedActiveId = localStorage.getItem('tf_activeDocId');

      if (storedDocs) {
        documents = JSON.parse(storedDocs);
        activeDocId = storedActiveId ? parseInt(storedActiveId) : (documents.length > 0 ? documents[0].id : null);
      }

      if (documents.length === 0) createNewDoc(true);
      else {
        const exists = documents.find(d => d.id === activeDocId);
        if (!exists) activeDocId = documents[0].id;
      }

      renderDocList();
      loadActiveDocument();

      const storedTheme = localStorage.getItem('tf_theme');
      if (storedTheme) setTheme(storedTheme);
    }

    function saveState() {
      localStorage.setItem('tf_documents', JSON.stringify(documents));
      localStorage.setItem('tf_activeDocId', activeDocId);
      renderDocList();
    }

    function createNewDoc(silent = false) {
      const newDoc = { id: Date.now(), title: "Untitled Document", content: "", date: new Date().toLocaleDateString() };
      documents.unshift(newDoc);
      activeDocId = newDoc.id;
      if (!silent) { saveState(); loadActiveDocument(); }
    }

    function loadActiveDocument() {
      const doc = documents.find(d => d.id === activeDocId);
      if (!doc) return;
      document.getElementById('doc-title-input').value = doc.title;
      if (doc.content) quill.setContents(doc.content);
      else quill.setText('');
      sizeInput.value = 16;
      renderDocList();
    }

    document.getElementById('doc-title-input').addEventListener('input', function (e) {
      const doc = documents.find(d => d.id === activeDocId);
      if (doc) {
        doc.title = e.target.value;
        clearTimeout(window.saveTimeout);
        window.saveTimeout = setTimeout(() => saveState(), 500);
      }
    });

    function duplicateDoc(id) {
      const original = documents.find(d => d.id === id);
      if (!original) return;
      const newDoc = { ...original, id: Date.now(), title: original.title + " (Copy)" };
      documents.unshift(newDoc);
      saveState();
    }

    function deleteDoc(id) {
      if (!confirm("Delete this document?")) return;
      documents = documents.filter(d => d.id !== id);
      if (activeDocId === id) {
        if (documents.length > 0) activeDocId = documents[0].id;
        else createNewDoc(true);
        loadActiveDocument();
      }
      saveState();
    }

    function switchDoc(id) {
      activeDocId = id;
      localStorage.setItem('tf_activeDocId', id);
      loadActiveDocument();
      // Close mobile offcanvas if open
      const offcanvasEl = document.getElementById('mobileDocs');
      const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
      if (bsOffcanvas) bsOffcanvas.hide();
    }

    function renderDocList() {
      const listContainer = document.getElementById('document-list');
      const mobileListContainer = document.getElementById('document-list-mobile');

      const filterDesktop = document.getElementById('search-docs').value.toLowerCase();
      const filterMobile = document.getElementById('search-docs-mobile')?.value.toLowerCase() || '';

      const render = (container, filter) => {
        container.innerHTML = '';
        documents.forEach(doc => {
          if (filter && !doc.title.toLowerCase().includes(filter)) return;
          const isActive = doc.id === activeDocId ? 'active-doc' : '';
          const itemHtml = `
                <div class="doc-item ${isActive}">
                    <div class="d-flex justify-content-between align-items-start" onclick="switchDoc(${doc.id})">
                        <div style="width: 80%">
                            <div class="fw-bold text-truncate" style="color: var(--text-main); font-size: 0.9rem;">${doc.title}</div>
                            <div class="text-truncate" style="color: var(--text-muted); font-size: 0.75rem;">${new Date(doc.id).toLocaleDateString()}</div>
                        </div>
                        <div class="dropdown" onclick="event.stopPropagation()">
                            <button class="btn btn-link btn-sm p-0 text-decoration-none" style="color: var(--text-muted);" data-bs-toggle="dropdown"><i class="ph ph-dots-three-vertical"></i></button>
                            <ul class="dropdown-menu dropdown-menu-end shadow">
                                <li><a class="dropdown-item" href="#" onclick="duplicateDoc(${doc.id})"><i class="ph ph-copy me-2"></i> Duplicate</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteDoc(${doc.id})"><i class="ph ph-trash me-2"></i> Delete</a></li>
                            </ul>
                        </div>
                    </div>
                </div>`;
          container.innerHTML += itemHtml;
        });
      }

      render(listContainer, filterDesktop);
      if (mobileListContainer) render(mobileListContainer, filterMobile);
    }

    document.getElementById('search-docs').addEventListener('input', renderDocList);
    // Search for mobile
    document.getElementById('search-docs-mobile')?.addEventListener('input', renderDocList);

    quill.on('text-change', function (delta, oldDelta, source) {
      if (source === 'user') {
        const doc = documents.find(d => d.id === activeDocId);
        if (doc) {
          doc.content = quill.getContents();
          const text = quill.getText();
          const words = text.trim().length === 0 ? 0 : text.trim().split(/\s+/).length;
          document.getElementById('word-count').innerText = `${words} Words | ${text.length} Chars`;
          document.getElementById('reading-time').innerText = `~${Math.ceil(words / 200)} min read`;
          clearTimeout(window.saveTimeout);
          document.getElementById('status-indicator').classList.add('d-none');
          window.saveTimeout = setTimeout(() => { saveState(); document.getElementById('status-indicator').classList.remove('d-none'); }, 1000);
        }
      }
    });

    function imageHandler() {
      const input = document.getElementById('image-upload');
      input.click();
      input.onchange = () => {
        const file = input.files[0];
        if (/^image\//.test(file.type)) {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => {
            const range = quill.getSelection();
            quill.insertEmbed(range.index, 'image', reader.result);
          };
        }
      };
    }

    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const html = document.documentElement;

    function setTheme(mode) {
      if (mode === 'light') {
        html.removeAttribute('data-theme');
        themeIcon.className = 'ph ph-sun fs-5';
        localStorage.setItem('tf_theme', 'light');
      } else {
        html.setAttribute('data-theme', 'dark');
        themeIcon.className = 'ph ph-moon fs-5';
        localStorage.setItem('tf_theme', 'dark');
      }
    }
    themeToggle.addEventListener('click', () => {
      setTheme(html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    });

    document.getElementById("menu-toggle").onclick = (e) => {
      e.preventDefault();
      const sidebar = document.getElementById("sidebar-wrapper");
      if (window.innerWidth <= 768) {
        sidebar.classList.toggle("mobile-show");
        document.getElementById("mobileOverlay").classList.toggle("show");
      } else {
        sidebar.classList.toggle("toggled");
      }
    };
    document.getElementById("mobileOverlay").onclick = () => {
      document.getElementById("sidebar-wrapper").classList.remove("mobile-show");
      document.getElementById("mobileOverlay").classList.remove("show");
    };

    function triggerSave() { saveState(); alert("Saved!"); }
    initApp();

  </script>
</body>

</html>
