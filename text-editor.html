<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RQR9BDLJ26"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-RQR9BDLJ26');
  </script>

  <meta charset="UTF-8" />
  <title>TaskFlows · Text Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="Untitled.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #6366f1;
      --primary-soft: #eef2ff;
      --primary-soft-2: #e0e7ff;
      --ink: #0f172a;
      --ink-2: #111827;
      --ink-3: #6b7280;
      --ink-4: #9ca3af;

      --bg: #f5f5f7;
      --bg-soft: #eef0f4;
      --card: #ffffff;
      --glass: rgba(255, 255, 255, 0.9);

      --border: #e5e7eb;
      --muted: #f3f4f6;
      --muted-2: #e5e7eb;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      --radius: 14px;
      --r-sm: 10px;
      --speed: .18s;
    }

    .dark {
      --bg: #020617;
      --bg-soft: #020617;
      --card: #020617;
      --glass: rgba(15, 23, 42, 0.96);

      --ink: #e5e7eb;
      --ink-2: #e5e7eb;
      --ink-3: #9ca3af;
      --ink-4: #6b7280;

      --border: #1f2937;
      --muted: #020617;
      --muted-2: #020617;
      --shadow: 0 18px 45px rgba(0, 0, 0, 0.5);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100%;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink-2);
      -webkit-font-smoothing: antialiased;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    body {
      display: flex;
      min-height: 100vh;
    }

    .wrap {
      display: flex;
      flex: 1;
      min-height: 100vh;
    }

    /* Sidebar (Docs + Nav) */
    .sidebar {
      width: 270px;
      flex: 0 0 270px;
      background: var(--glass);
      backdrop-filter: blur(18px);
      border-right: 1px solid var(--border);
      padding: 16px 16px 18px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: auto;
      box-shadow: 10px 0 40px rgba(15, 23, 42, 0.06);
      display: flex;
      flex-direction: column;
      gap: 14px;
      transition: transform .2s ease;
    }

    .sidebar.hidden {
      transform: translateX(-100%);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: radial-gradient(circle at 30% 20%, #a855f7, #4f46e5);
      box-shadow: 0 10px 25px rgba(88, 80, 236, 0.35);
    }

    .logo-badge svg {
      filter: drop-shadow(0 1px 0 rgba(255, 255, 255, 0.3));
    }

    .app-title {
      font-weight: 800;
      letter-spacing: -.03em;
      font-size: 1.2rem;
      color: var(--ink-2);
    }

    .app-sub {
      font-size: .82rem;
      font-weight: 500;
      color: var(--ink-4);
    }

    .side-label {
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: var(--ink-4);
      margin: 8px 2px 4px;
    }

    .side-nav {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .side-nav a {
      font: 500 .9rem/1.2 'Inter', sans-serif;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 9px;
      border-radius: var(--r-sm);
      color: var(--ink-3);
      background: transparent;
      transition: background var(--speed), color var(--speed);
    }

    .side-nav a:hover {
      background: var(--muted);
      color: var(--ink-2);
    }

    .side-nav .active {
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 600;
    }

    .nav-dot {
      width: 20px;
      height: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--muted);
      flex-shrink: 0;
      display: grid;
      place-items: center;
      font-size: .7rem;
      font-weight: 600;
      color: var(--ink-3);
    }

    .nav-dot-docs {
      background: linear-gradient(135deg, #eef2ff, #e0f2fe);
    }

    .nav-dot-dash {
      background: linear-gradient(135deg, #e0e7ff, #f5f3ff);
    }

    .nav-dot-lists {
      background: linear-gradient(135deg, #dcfce7, #fee2e2);
    }

    /* Docs list */
    .docs-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 2px;
    }

    .docs-title {
      font-size: .86rem;
      font-weight: 600;
      color: var(--ink-3);
    }

    .btn-small {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 3px 8px;
      font-size: .75rem;
      background: var(--card);
      cursor: pointer;
      color: var(--ink-3);
    }

    .btn-small:hover {
      background: var(--muted);
    }

    .doc-list {
      list-style: none;
      margin: 6px 0 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 280px;
      overflow: auto;
    }

    .doc-item {
      border-radius: var(--r-sm);
      border: 1px solid transparent;
      padding: 6px 7px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
    }

    .doc-item:hover {
      background: var(--muted);
    }

    .doc-item.active {
      background: var(--primary-soft);
      border-color: var(--primary-soft-2);
    }

    .doc-name {
      font-size: .85rem;
      font-weight: 500;
      color: var(--ink-2);
    }

    .doc-meta {
      font-size: .72rem;
      color: var(--ink-4);
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .doc-actions {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .doc-actions button {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      font-size: .7rem;
      padding: 2px 6px;
      cursor: pointer;
      color: var(--ink-4);
    }

    .doc-actions button:hover {
      background: var(--muted);
      color: var(--ink-3);
    }

    .side-footer {
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: .78rem;
      color: var(--ink-4);
    }

    .side-footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-outline {
      background: transparent;
      border-radius: var(--r-sm);
      border: 1px solid var(--border);
      font-size: .8rem;
      padding: 7px 10px;
      color: var(--ink-3);
      cursor: pointer;
    }

    .btn-outline:hover {
      background: var(--muted);
    }

    /* Main area */
    .main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top left, rgba(99, 102, 241, 0.08), transparent 55%), var(--bg);
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid var(--border);
      padding: 10px 18px;
      background: rgba(245, 245, 247, 0.95);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .dark .topbar {
      background: rgba(2, 6, 23, 0.96);
    }

    .topbar-inner {
      width: 100%;
      max-width: 1100px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .doc-title-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 12px;
      font-size: .95rem;
      font-weight: 600;
      background: var(--card);
      color: var(--ink-2);
      outline: none;
    }

    .doc-title-input::placeholder {
      color: var(--ink-4);
      font-weight: 500;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 7px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: .8rem;
      font-weight: 600;
      color: var(--ink-3);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: var(--shadow);
      transition: background var(--speed), border-color var(--speed), color var(--speed), transform .08s;
    }

    .btn.primary {
      background: #111827;
      border-color: #111827;
      color: #f9fafb;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn-pill {
      border-radius: 999px;
    }

    .btn-icon-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: radial-gradient(circle at 30% 20%, #4f46e5, #0f172a);
    }

    .btn-icon-focus {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, #0f172a, #1e293b);
      position: relative;
    }

    .btn-icon-focus::before {
      content: '';
      position: absolute;
      inset: 3px;
      border-radius: 2px;
      border: 1px solid #e5e7eb;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      object-fit: cover;
      cursor: pointer;
    }

    /* Toolbar */
    .toolbar-wrap {
      display: flex;
      justify-content: center;
      padding: 8px 16px 4px;
      border-bottom: 1px solid var(--border);
    }

    .toolbar {
      width: 100%;
      max-width: 1100px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .tool-group {
      display: inline-flex;
      border-radius: 999px;
      background: var(--card);
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .tool-btn {
      border: none;
      background: transparent;
      padding: 6px 9px;
      font-size: .78rem;
      font-weight: 500;
      color: var(--ink-3);
      cursor: pointer;
      border-right: 1px solid var(--border);
      min-width: 30px;
    }

    .tool-btn:last-child {
      border-right: none;
    }

    .tool-btn:hover {
      background: var(--muted);
      color: var(--ink-2);
    }

    .tool-btn.active {
      background: var(--primary-soft);
      color: var(--primary);
    }

    .tool-label {
      padding: 0 8px;
      font-size: .78rem;
      color: var(--ink-4);
    }

    .tool-select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 5px 10px;
      font-size: .78rem;
      font-weight: 500;
      background: var(--card);
      color: var(--ink-3);
      cursor: pointer;
    }

    /* Editor area */
    .editor-shell {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 16px 16px 18px;
      overflow: auto;
    }

    .editor-wrap {
      max-width: 1100px;
      width: 100%;
      display: flex;
      justify-content: center;
    }

    .editor-page {
      background: var(--card);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.12);
      padding: 32px 46px 40px;
      border: 1px solid var(--border);
      width: 100%;
      min-height: calc(100vh - 200px);
      max-width: 800px;
    }

    #editor {
      outline: none;
      min-height: 500px;
      font-size: .98rem;
      line-height: 1.6;
      color: var(--ink-2);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    #editor h1,
    #editor h2,
    #editor h3 {
      margin: 1.2em 0 .4em;
      font-weight: 700;
    }

    #editor h1 {
      font-size: 1.7rem;
    }

    #editor h2 {
      font-size: 1.45rem;
    }

    #editor h3 {
      font-size: 1.25rem;
    }

    #editor p {
      margin: .3em 0;
    }

    #editor ul,
    #editor ol {
      padding-left: 1.3em;
      margin: .3em 0;
    }

    #editor blockquote {
      border-left: 3px solid var(--primary-soft-2);
      padding-left: 10px;
      color: var(--ink-3);
      margin: .6em 0;
      font-style: italic;
    }

    #editor hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 1.2em 0;
    }

    .todo-list {
      list-style: none;
      padding-left: 0;
      margin: .3em 0;
    }

    .todo-list li {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: .2em 0;
    }

    .todo-list input[type="checkbox"] {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .code-inline {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .86rem;
      background: var(--muted);
      border-radius: 4px;
      padding: 2px 4px;
    }

    .highlight {
      background: #fef3c7;
    }

    /* Status bar */
    .statusbar {
      border-top: 1px solid var(--border);
      padding: 6px 16px 8px;
      display: flex;
      justify-content: center;
      font-size: .78rem;
      color: var(--ink-4);
      background: rgba(248, 250, 252, 0.9);
      backdrop-filter: blur(10px);
    }

    .dark .statusbar {
      background: rgba(15, 23, 42, 0.9);
    }

    .status-inner {
      width: 100%;
      max-width: 1100px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .status-left,
    .status-right {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #16a34a;
      box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.18);
    }

    .dot.unsaved {
      background: #f97316;
      box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.16);
    }

    .kbd {
      font-weight: 600;
      border: 1px solid var(--border);
      padding: 1px 5px;
      border-radius: 5px;
      background: var(--card);
      font-size: .75rem;
    }

    /* Toasts */
    .toasts {
      position: fixed;
      right: 14px;
      bottom: 14px;
      display: grid;
      gap: 6px;
      z-index: 40;
    }

    .toast {
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 7px 9px;
      border-radius: 12px;
      font-weight: 600;
      font-size: .8rem;
      color: var(--ink-2);
    }

    .toast.ok {
      border-color: #bbf7d0;
    }

    .toast.bad {
      border-color: #fecaca;
    }

    /* Profile dropdown (simple) */
    .pbox {
      position: relative;
    }

    .pdrop {
      position: absolute;
      right: 0;
      top: 38px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      min-width: 220px;
      box-shadow: var(--shadow);
      display: none;
      padding: 8px 10px 10px;
      z-index: 20;
      font-size: .8rem;
    }

    .pdrop.show {
      display: block;
    }

    .pdrop .name {
      font-weight: 700;
      font-size: .9rem;
    }

    .pdrop .email {
      color: var(--ink-3);
      font-weight: 500;
      font-size: .78rem;
    }

    .pdrop .bio {
      margin: 5px 0;
      color: var(--ink-3);
      font-weight: 400;
      font-size: .78rem;
    }

    .pdrop .line {
      border-top: 1px solid var(--border);
      margin: 6px 0;
    }

    .pdrop .btn {
      width: 100%;
      justify-content: center;
      box-shadow: none;
      border-radius: var(--r-sm);
    }

    /* Responsive */
    @media (max-width: 900px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        z-index: 30;
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main {
        flex: 1;
      }

      .topbar-inner {
        flex-wrap: wrap;
      }

      .editor-page {
        padding: 22px 18px 26px;
      }
    }

    @media (max-width: 600px) {
      .toolbar {
        justify-content: center;
      }
    }

    .focus-mode .sidebar {
      transform: translateX(-100%);
    }

    .focus-mode .topbar,
    .focus-mode .toolbar-wrap,
    .focus-mode .statusbar {
      border-color: transparent;
      background: transparent;
      box-shadow: none;
      backdrop-filter: none;
    }

    .focus-mode .editor-page {
      box-shadow: none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="logo">
        <span class="logo-badge" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff">
            <rect x="3" y="3" width="18" height="18" rx="6" opacity=".15"></rect>
            <rect x="7" y="7" width="10" height="10" rx="3"></rect>
          </svg>
        </span>
        <div>
          <div class="app-title">TaskFlows</div>
          <div class="app-sub">Text Editor</div>
        </div>
      </div>

      <!-- Workspace navigation -->
      <div class="side-label">Workspace</div>
      <ul class="side-nav">
        <li>
          <a href="dashboard.html">
            <span class="nav-dot nav-dot-dash">D</span>
            Dashboard
          </a>
        </li>
        <li>
          <a href="journal.html">
            <span class="nav-dot nav-dot-docs">J</span>
            Journal
          </a>
        </li>
        <li>
          <a href="lists.html">
            <span class="nav-dot nav-dot-lists">Ls</span>
            Lists
          </a>
        </li>
        <li>
          <a href="notes.html">
            <span class="nav-dot nav-dot-docs">N</span>
            Notes
          </a>
        </li>
        <li>
          <a href="quicknotes.html">
            <span class="nav-dot nav-dot-docs">Q</span>
            Quick Notes
          </a>
        </li>
        <li>
          <a href="text-editor.html" class="active">
            <span class="nav-dot nav-dot-docs">E</span>
            Text Editor
          </a>
        </li>
        <li>
          <a href="to-do-list.html">
            <span class="nav-dot nav-dot-lists">T</span>
            To-Do Lists
          </a>
        </li>
        <li>
          <a href="whiteboard.html">
            <span class="nav-dot nav-dot-lists">W</span>
            Whiteboard
          </a>
        </li>
      </ul>

      <!-- Documents section -->
      <div class="side-label">Documents</div>
      <div class="docs-header">
        <div class="docs-title">Your docs</div>
        <button class="btn-small" id="newDocBtn">New</button>
      </div>
      <ul class="doc-list" id="docList"></ul>

      <!-- Footer -->
      <div class="side-footer">
        <div class="side-footer-row">
          <span>Theme</span>
          <button class="btn-outline" id="themeToggleSide">Toggle</button>
        </div>
        <div class="side-footer-row">
          <span>Sidebar</span>
          <button class="btn-outline" id="hideSidebarBtn">Hide</button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div class="topbar-inner">
          <input id="docTitle" class="doc-title-input" placeholder="Untitled document" />
          <div class="top-actions">
            <button class="btn btn-pill" id="focusModeBtn" title="Toggle focus mode">
              <span class="btn-icon-focus"></span>Focus
            </button>
            <button class="btn btn-pill" id="themeToggleTop">
              <span class="btn-icon-dot"></span>Theme
            </button>
            <button class="btn" id="saveBtn">Save</button>
            <button class="btn" id="exportTxtBtn">Export .txt</button>
            <button class="btn" id="exportHtmlBtn">Export .html</button>
            <div class="pbox">
              <img id="topAvatar" class="avatar" alt="Profile" />
              <div class="pdrop" id="pdrop">
                <div class="name" id="pdName">Guest</div>
                <div class="email" id="pdEmail">—</div>
                <div class="bio" id="pdBio">No bio yet.</div>
                <div class="line"></div>
                <button class="btn" id="dummyProfileBtn">Open profile in dashboard</button>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Toolbar -->
      <section class="toolbar-wrap">
        <div class="toolbar">
          <select id="blockFormat" class="tool-select" title="Block style">
            <option value="p">Normal text</option>
            <option value="h1">Heading 1</option>
            <option value="h2">Heading 2</option>
            <option value="h3">Heading 3</option>
          </select>

          <div class="tool-group">
            <button class="tool-btn" data-cmd="bold" title="Bold (Ctrl+B)">B</button>
            <button class="tool-btn" data-cmd="italic" title="Italic (Ctrl+I)" style="font-style:italic;">I</button>
            <button class="tool-btn" data-cmd="underline" title="Underline (Ctrl+U)"
              style="text-decoration:underline;">U</button>
            <button class="tool-btn" data-cmd="strikeThrough" title="Strikethrough"
              style="text-decoration:line-through;">S</button>
          </div>

          <div class="tool-group">
            <button class="tool-btn" data-cmd="insertUnorderedList" title="Bulleted list">• List</button>
            <button class="tool-btn" data-cmd="insertOrderedList" title="Numbered list">1. List</button>
            <button class="tool-btn" id="todoBtn" title="Checklist">☑︎ Tasks</button>
          </div>

          <div class="tool-group">
            <button class="tool-btn" data-cmd="justifyLeft" title="Align left">≡</button>
            <button class="tool-btn" data-cmd="justifyCenter" title="Align center">≣</button>
            <button class="tool-btn" data-cmd="justifyRight" title="Align right">≡</button>
          </div>

          <div class="tool-group">
            <button class="tool-btn" data-cmd="outdent" title="Decrease indent">←</button>
            <button class="tool-btn" data-cmd="indent" title="Increase indent">→</button>
          </div>

          <div class="tool-group">
            <button class="tool-btn" id="quoteBtn" title="Quote">“”</button>
            <button class="tool-btn" id="inlineCodeBtn" title="Inline code">{ }</button>
            <button class="tool-btn" id="highlightBtn" title="Highlight">HL</button>
            <button class="tool-btn" id="dividerBtn" title="Insert divider">—</button>
          </div>

          <div class="tool-group">
            <button class="tool-btn" data-cmd="undo" title="Undo">↺</button>
            <button class="tool-btn" data-cmd="redo" title="Redo">↻</button>
            <button class="tool-btn" data-cmd="removeFormat" title="Clear formatting">CLR</button>
          </div>
        </div>
      </section>

      <!-- Editor -->
      <section class="editor-shell">
        <div class="editor-wrap">
          <div class="editor-page">
            <div id="editor" contenteditable="true"></div>
          </div>
        </div>
      </section>

      <!-- Status -->
      <footer class="statusbar">
        <div class="status-inner">
          <div class="status-left">
            <span id="saveDot" class="dot unsaved"></span>
            <span id="saveStatus">Unsaved changes</span>
          </div>
          <div class="status-right">
            <span id="wordCount">0 words</span>
            <span id="charCount">0 characters</span>
            <span id="readTime">~0 min read</span>
            <span>Press <span class="kbd">Ctrl + S</span> to save</span>
          </div>
        </div>
      </footer>
    </main>
  </div>

  <div class="toasts" id="toasts"></div>

  <script>
    /* ===== Keys & Helpers ===== */
    const KEY_THEME = 'taskflows-theme';
    const KEY_DOCS = 'taskflows-docs';
    const KEY_ACTIVE_DOC = 'taskflows-active-doc';
    const KEY_PROFILE = 'taskflows-profile';

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const uid = () => 'd_' + Math.random().toString(36).slice(2, 9);

    const toast = (msg, type = 'ok') => {
      const t = document.createElement('div');
      t.className = 'toast ' + (type === 'ok' ? 'ok' : 'bad');
      t.textContent = msg;
      $('#toasts').appendChild(t);
      setTimeout(() => {
        t.style.opacity = 0;
        setTimeout(() => t.remove(), 250);
      }, 1800);
    };

    const getTheme = () => localStorage.getItem(KEY_THEME) || 'dark';
    const setTheme = (t) => {
      localStorage.setItem(KEY_THEME, t);
      document.documentElement.classList.toggle('dark', t === 'dark');
    };

    const getDocs = () => JSON.parse(localStorage.getItem(KEY_DOCS) || '[]');
    const setDocs = (arr) => localStorage.setItem(KEY_DOCS, JSON.stringify(arr));
    const getActiveId = () => localStorage.getItem(KEY_ACTIVE_DOC) || null;
    const setActiveId = (id) => localStorage.setItem(KEY_ACTIVE_DOC, id);

    const defaultProfile = () => ({
      name: 'Guest',
      email: '',
      bio: '',
      avatar: 'https://api.dicebear.com/8.x/identicon/svg?seed=guest'
    });

    const getProfile = () => {
      try {
        return JSON.parse(localStorage.getItem(KEY_PROFILE) || 'null') || defaultProfile();
      } catch {
        return defaultProfile();
      }
    };

    function fmtDateShort(ts) {
      if (!ts) return '—';
      const d = new Date(ts);
      if (isNaN(d)) return '—';
      const month = d.getMonth() + 1;
      const day = d.getDate();
      return `${month}/${day}`;
    }

    function countStats(text) {
      const trimmed = text.trim();
      const words = trimmed ? trimmed.split(/\s+/).length : 0;
      const chars = text.replace(/\s/g, '').length;
      const minutes = words ? Math.max(1, Math.round(words / 200)) : 0;
      return { words, chars, minutes };
    }

    /* ===== State ===== */
    let activeDoc = null;
    let autosaveTimer = null;
    let dirty = false;

    /* ===== Theme & Profile UI ===== */
    setTheme(getTheme());

    function renderProfile() {
      const u = getProfile();
      $('#topAvatar').src = u.avatar || defaultProfile().avatar;
      $('#pdName').textContent = u.name || 'Guest';
      $('#pdEmail').textContent = u.email || '—';
      $('#pdBio').textContent = u.bio || 'No bio yet.';
    }

    /* ===== Docs CRUD ===== */
    function ensureDocsSeed() {
      const docs = getDocs();
      if (docs.length === 0) {
        const id = uid();
        const now = Date.now();
        const initial = {
          id,
          title: 'Welcome to TaskFlows Editor',
          content: '<h1>Welcome to TaskFlows Editor</h1><p>Start typing here, or create a new document from the sidebar.</p><p>You can format text, create lists, checklists, quotes, and more.\nTry pressing <span class="code-inline">Ctrl + S</span> to save.</p>',
          created: now,
          updated: now
        };
        setDocs([initial]);
        setActiveId(id);
      }
    }

    function renderDocList() {
      const list = $('#docList');
      list.innerHTML = '';
      const docs = getDocs().sort((a, b) => b.updated - a.updated);
      const activeId = activeDoc?.id || getActiveId();

      docs.forEach(doc => {
        const li = document.createElement('li');
        li.className = 'doc-item' + (doc.id === activeId ? ' active' : '');
        li.dataset.id = doc.id;
        li.innerHTML = `
          <div class="doc-name">${doc.title || 'Untitled document'}</div>
          <div class="doc-meta">
            <span>${fmtDateShort(doc.updated)}</span>
            <span>${Math.max(1, Math.round((doc.content || '').length / 80))} lines</span>
          </div>
          <div class="doc-actions">
            <button data-act="rename">Rename</button>
            <button data-act="duplicate">Duplicate</button>
            <button data-act="delete">Delete</button>
          </div>
        `;
        list.appendChild(li);
      });
    }

    function loadDoc(id) {
      const docs = getDocs();
      const doc = docs.find(d => d.id === id) || docs[0];
      if (!doc) return;
      activeDoc = { ...doc };
      setActiveId(doc.id);
      $('#docTitle').value = doc.title || '';
      $('#editor').innerHTML = doc.content || '';
      dirty = false;
      updateDirtyUI();
      updateStatsUI();
      renderDocList();
    }

    function saveActiveDoc(showToast = true) {
      if (!activeDoc) return;
      const docs = getDocs();
      const index = docs.findIndex(d => d.id === activeDoc.id);
      const now = Date.now();
      const title = $('#docTitle').value.trim() || 'Untitled document';
      const content = $('#editor').innerHTML;

      const updatedDoc = {
        ...(index >= 0 ? docs[index] : activeDoc),
        id: activeDoc.id,
        title,
        content,
        updated: now
      };

      if (index >= 0) docs[index] = updatedDoc;
      else docs.push(updatedDoc);

      setDocs(docs);
      activeDoc = { ...updatedDoc };
      dirty = false;
      updateDirtyUI();
      renderDocList();
      if (showToast) toast('Document saved');
    }

    function newDoc() {
      const id = uid();
      const now = Date.now();
      const docs = getDocs();
      const doc = {
        id,
        title: 'Untitled document',
        content: '',
        created: now,
        updated: now
      };
      docs.push(doc);
      setDocs(docs);
      setActiveId(id);
      loadDoc(id);
      toast('New document created');
    }

    function renameDoc(id) {
      const docs = getDocs();
      const idx = docs.findIndex(d => d.id === id);
      if (idx < 0) return;
      const current = docs[idx].title || 'Untitled document';
      const name = prompt('Rename document:', current);
      if (name === null) return;
      docs[idx].title = name.trim() || current;
      docs[idx].updated = Date.now();
      setDocs(docs);
      if (activeDoc && activeDoc.id === id) {
        $('#docTitle').value = docs[idx].title;
        activeDoc.title = docs[idx].title;
      }
      renderDocList();
    }

    function duplicateDoc(id) {
      const docs = getDocs();
      const src = docs.find(d => d.id === id);
      if (!src) return;
      const now = Date.now();
      const copy = {
        ...src,
        id: uid(),
        title: src.title + ' (Copy)',
        created: now,
        updated: now
      };
      docs.push(copy);
      setDocs(docs);
      setActiveId(copy.id);
      loadDoc(copy.id);
      toast('Document duplicated');
    }

    function deleteDoc(id) {
      const docs = getDocs();
      const doc = docs.find(d => d.id === id);
      if (!doc) return;
      if (!confirm(`Delete "${doc.title || 'Untitled document'}"?`)) return;
      const nextDocs = docs.filter(d => d.id !== id);
      setDocs(nextDocs);
      if (nextDocs.length === 0) {
        setActiveId('');
        activeDoc = null;
        $('#docTitle').value = '';
        $('#editor').innerHTML = '';
        renderDocList();
        toast('Document deleted');
        return;
      }
      const newActive = nextDocs[0];
      setActiveId(newActive.id);
      loadDoc(newActive.id);
      toast('Document deleted');
    }

    /* ===== Editor Commands ===== */
    function execCmd(cmd, value = null) {
      document.execCommand(cmd, false, value);
      $('#editor').focus();
      markDirty();
    }

    function applyBlockFormat(tag) {
      const blockMap = {
        h1: 'H1',
        h2: 'H2',
        h3: 'H3',
        p: 'P'
      };
      const block = blockMap[tag] || 'P';
      document.execCommand('formatBlock', false, block);
      $('#editor').focus();
      markDirty();
    }

    function insertChecklist() {
      const html = '<ul class="todo-list"><li><input type="checkbox" /> Task 1</li><li><input type="checkbox" /> Task 2</li></ul>';
      document.execCommand('insertHTML', false, html);
      $('#editor').focus();
      markDirty();
    }

    function wrapSelection(tagClass) {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      if (range.collapsed) {
        // insert inline wrapper at cursor
        const span = document.createElement('span');
        span.className = tagClass;
        span.textContent = 'text';
        range.insertNode(span);
        sel.removeAllRanges();
        const newRange = document.createRange();
        newRange.selectNodeContents(span);
        sel.addRange(newRange);
      } else {
        const span = document.createElement('span');
        span.className = tagClass;
        span.appendChild(range.extractContents());
        range.insertNode(span);
      }
      markDirty();
    }

    function insertDivider() {
      document.execCommand('insertHorizontalRule', false, null);
      $('#editor').focus();
      markDirty();
    }

    function insertQuote() {
      document.execCommand('formatBlock', false, 'BLOCKQUOTE');
      $('#editor').focus();
      markDirty();
    }

    /* ===== Stats & Dirty State ===== */
    function markDirty() {
      dirty = true;
      updateDirtyUI();
      updateStatsUI();
      scheduleAutosave();
    }

    function updateDirtyUI() {
      const dot = $('#saveDot');
      const txt = $('#saveStatus');
      if (!dirty) {
        dot.classList.remove('unsaved');
        txt.textContent = 'All changes saved';
      } else {
        dot.classList.add('unsaved');
        txt.textContent = 'Unsaved changes';
      }
    }

    function updateStatsUI() {
      const text = $('#editor').innerText || '';
      const { words, chars, minutes } = countStats(text);
      $('#wordCount').textContent = `${words} word${words === 1 ? '' : 's'}`;
      $('#charCount').textContent = `${chars} character${chars === 1 ? '' : 's'}`;
      $('#readTime').textContent = minutes ? `~${minutes} min read` : '~0 min read';
    }

    function scheduleAutosave() {
      if (autosaveTimer) clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        if (dirty) saveActiveDoc(false);
      }, 1000);
    }

    /* ===== Export ===== */
    function downloadFile(filename, text, type = 'text/plain') {
      const blob = new Blob([text], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportTxt() {
      const title = $('#docTitle').value.trim() || 'document';
      const text = $('#editor').innerText || '';
      downloadFile(title.replace(/[^\w\-]+/g, '_') + '.txt', text, 'text/plain');
      toast('Exported as .txt');
    }

    function exportHtml() {
      const title = $('#docTitle').value.trim() || 'document';
      const html = $('#editor').innerHTML || '';
      const fullHtml = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${title}</title></head><body>${html}</body></html>`;
      downloadFile(title.replace(/[^\w\-]+/g, '_') + '.html', fullHtml, 'text/html');
      toast('Exported as .html');
    }

    /* ===== Focus & Sidebar ===== */
    function toggleFocusMode() {
      document.body.classList.toggle('focus-mode');
    }

    function toggleSidebarMobile() {
      $('#sidebar').classList.toggle('open');
    }

    /* ===== Events ===== */
    document.addEventListener('DOMContentLoaded', () => {
      ensureDocsSeed();
      renderDocList();
      const activeId = getActiveId();
      const docs = getDocs();
      const firstId = activeId || (docs[0] && docs[0].id);
      if (firstId) loadDoc(firstId);

      renderProfile();
      updateStatsUI();
    });

    // Toolbar buttons
    $$('.tool-btn[data-cmd]').forEach(btn => {
      btn.addEventListener('click', () => {
        const cmd = btn.dataset.cmd;
        execCmd(cmd);
      });
    });

    $('#blockFormat').addEventListener('change', (e) => {
      applyBlockFormat(e.target.value);
    });

    $('#todoBtn').addEventListener('click', insertChecklist);
    $('#dividerBtn').addEventListener('click', insertDivider);
    $('#quoteBtn').addEventListener('click', insertQuote);
    $('#inlineCodeBtn').addEventListener('click', () => wrapSelection('code-inline'));
    $('#highlightBtn').addEventListener('click', () => wrapSelection('highlight'));

    // Editor input
    $('#editor').addEventListener('input', markDirty);
    $('#docTitle').addEventListener('input', markDirty);

    // Save & Export
    $('#saveBtn').addEventListener('click', () => saveActiveDoc(true));
    $('#exportTxtBtn').addEventListener('click', exportTxt);
    $('#exportHtmlBtn').addEventListener('click', exportHtml);

    // Theme toggles
    $('#themeToggleTop').addEventListener('click', () => {
      const next = getTheme() === 'dark' ? 'light' : 'dark';
      setTheme(next);
    });
    $('#themeToggleSide').addEventListener('click', () => {
      const next = getTheme() === 'dark' ? 'light' : 'dark';
      setTheme(next);
    });

    // Focus mode
    $('#focusModeBtn').addEventListener('click', toggleFocusMode);

    // Sidebar show/hide
    $('#hideSidebarBtn').addEventListener('click', () => {
      $('#sidebar').classList.toggle('hidden');
    });

    // Doc list click
    $('#docList').addEventListener('click', (e) => {
      const item = e.target.closest('.doc-item');
      if (!item) return;
      const id = item.dataset.id;
      const actBtn = e.target.closest('button[data-act]');
      if (actBtn) {
        const act = actBtn.dataset.act;
        if (act === 'rename') renameDoc(id);
        if (act === 'duplicate') duplicateDoc(id);
        if (act === 'delete') deleteDoc(id);
        return;
      }
      if (activeDoc && activeDoc.id === id) return;
      loadDoc(id);
    });

    // New doc
    $('#newDocBtn').addEventListener('click', newDoc);

    // Profile dropdown (simple)
    $('#topAvatar').addEventListener('click', () => {
      $('#pdrop').classList.toggle('show');
    });
    document.addEventListener('click', (e) => {
      if (!$('.pbox').contains(e.target)) {
        $('#pdrop').classList.remove('show');
      }
    });
    $('#dummyProfileBtn').addEventListener('click', () => {
      toast('Open your profile from the Dashboard page.');
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 's' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        saveActiveDoc(true);
      }
      // open/close sidebar on Ctrl/Cmd + \
      if (e.key === '\\' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        toggleSidebarMobile();
      }
    });
  </script>
</body>

</html>
