<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RQR9BDLJ26"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-RQR9BDLJ26');
  </script>
  <meta charset="UTF-8">
  <title>TaskFlows Drafts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Montserrat:wght@600;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #7c3aed;
      --secondary: #10b981;
      --danger: #ef4444;
      --danger-dark: #b91c1c;
      --background: linear-gradient(120deg,#ede9fe,#e0fdfb 60%,#f3f4f6 100%);
      --card-bg: rgba(255,255,255,0.97);
      --radius: 22px;
      --radius-small: 12px;
      --shadow: 0 8px 32px 0 rgba(124,58,237,.10);
      --shadow-hover: 0 12px 50px 0 rgba(16,185,129,.13);
      --gradient-btn: linear-gradient(90deg,#7c3aed 10%,#10b981 90%);
      --gradient-btn-hover: linear-gradient(90deg,#10b981 10%,#7c3aed 90%);
      --muted: #a1a1aa;
      --title: #18181b;
      --date: #7c3aed;
      --card-max-width: 520px;
    }
    html, body {
      min-height: 100%;
      margin: 0;
      padding: 0;
      background: var(--background);
      font-family: 'Inter', 'Montserrat', sans-serif;
      color: var(--title);
      width: 100vw;
      overflow-x: hidden;
    }
    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background-size: 200% 200%;
      animation: move-bg 16s ease-in-out infinite alternate;
    }
    @keyframes move-bg {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    .drafts-container {
      width: 100%;
      max-width: 800px;
      min-height: 92vh;
      margin: 2vw 0 0 0;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0 0 40px 0;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: visible;
      z-index: 2;
      transition: box-shadow 0.2s;
    }
    .header-bar {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      background: linear-gradient(90deg,#ede9fe 60%,#d1fae5 100%);
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: 0 2px 18px #ede9fe44;
      padding: 40px 5vw 24px 5vw;
      position: relative;
    }
    .header-bar h2 {
      font-size: 2.25em;
      font-family: 'Montserrat', 'Inter', sans-serif;
      font-weight: 900;
      color: var(--primary);
      background: linear-gradient(90deg,#7c3aed,#10b981 70%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      margin: 0 0 12px 0;
      letter-spacing: -0.03em;
      filter: drop-shadow(0 4px 14px #ede9fe);
      user-select: none;
      transition: font-size 0.2s;
    }
    .header-actions {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .header-btn {
      background: var(--gradient-btn);
      color: #fff;
      border: none;
      border-radius: var(--radius-small);
      padding: 12px 26px 12px 26px;
      font-size: 1.04em;
      font-weight: 800;
      box-shadow: 0 2px 16px #885af820,0 1.5px 0 #fff inset;
      cursor: pointer;
      transition: background 0.16s,transform 0.14s,box-shadow 0.13s;
      outline: none;
      font-family: 'Montserrat', 'Inter', sans-serif;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 2px solid #ede9fe;
      position: relative;
      overflow: hidden;
    }
    .header-btn:hover, .header-btn:focus {
      background: var(--gradient-btn-hover);
      transform: translateY(-2px) scale(1.06);
      box-shadow: 0 6px 36px #bbf7d0,0 3px 0 #fff inset;
      color: #fff;
      z-index: 1;
    }
    .search-bar-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 22px 0 0 0;
      width: 100%;
    }
    .search-bar {
      width: 100%;
      max-width: 400px;
      background: #f3f4f6;
      border: none;
      font-size: 1.07em;
      border-radius: 10px;
      padding: 12px 16px;
      box-shadow: 0 1px 8px #d1fae51a;
      outline: none;
      transition: box-shadow 0.14s, background 0.13s;
      margin: 0;
    }
    .search-bar:focus {
      box-shadow: 0 4px 20px #bbf7d0;
      background: #fff;
    }
    .draft-list {
      margin: 0;
      padding: 36px 5vw 0 5vw;
      width: 100%;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 28px;
      flex: 1 1 auto;
      box-sizing: border-box;
      position: relative;
      z-index: 2;
      min-height: 350px;
    }
    .draft-item {
      background: var(--card-bg);
      border-radius: var(--radius-small);
      padding: 22px 22px 19px 22px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 120px;
      box-shadow: var(--shadow);
      border: 1.2px solid #ede9fe;
      position: relative;
      transition: box-shadow 0.18s, transform 0.17s, border-color 0.12s;
      overflow: hidden;
      animation: float-in 0.7s cubic-bezier(.5,0,.2,1);
      cursor: pointer;
      max-width: var(--card-max-width);
      margin-left: auto;
      margin-right: auto;
    }
    .draft-item:hover, .draft-item:focus-within {
      box-shadow: var(--shadow-hover);
      transform: translateY(-4px) scale(1.017);
      border-color: var(--secondary);
    }
    @keyframes float-in {
      from { opacity: 0; transform: translateY(80px) scale(0.93);}
      to   { opacity: 1; transform: translateY(0) scale(1);}
    }
    .draft-title {
      font-size: 1.13em;
      font-weight: 900;
      color: var(--title);
      font-family: 'Montserrat', 'Inter', sans-serif;
      word-break: break-word;
      letter-spacing: -0.01em;
      margin-bottom: 8px;
      line-height: 1.18;
      min-height: 1.7em;
      user-select: text;
      transition: color 0.18s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .draft-item:hover .draft-title { color: var(--primary);}
    .draft-date {
      color: var(--date);
      font-size: 0.97em;
      opacity: 0.92;
      font-weight: 600;
      font-family: 'Montserrat', 'Inter', sans-serif;
      margin-bottom: 18px;
      letter-spacing: 0.02em;
    }
    .draft-actions {
      margin-top: 9px;
      display: flex;
      gap: 17px;
      align-items: center;
      z-index: 2;
      position: relative;
      width: 100%;
    }
    .draft-actions button {
      background: var(--gradient-btn);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 20px;
      font-size: 1em;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 1px 8px #885af81a;
      transition: background 0.16s, box-shadow 0.10s, transform 0.12s;
      outline: none;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
      min-width: 82px;
    }
    .draft-actions button:hover,
    .draft-actions button:focus {
      background: var(--gradient-btn-hover);
      box-shadow: 0 4px 20px #bbf7d0;
      transform: translateY(-1px) scale(1.04);
    }
    .delete-btn {
      background: linear-gradient(90deg,var(--danger),var(--danger-dark));
      font-weight: 800;
      transition: background 0.14s;
    }
    .delete-btn:hover,
    .delete-btn:focus {
      background: linear-gradient(90deg,var(--danger-dark),var(--danger));
      color: #fff;
    }
    .icon {
      font-size: 1.17em;
      margin-right: 1px;
      vertical-align: middle;
      display: inline-block;
    }
    .empty-message {
      color: var(--muted);
      font-size: 1.24em;
      text-align: center;
      font-family: 'Montserrat', 'Inter', sans-serif;
      padding: 50px 0 30px 0;
      letter-spacing: 0.01em;
      background: rgba(255,255,255,0.70);
      border-radius: var(--radius-small);
      box-shadow: 0 4px 18px #d1fae533;
      margin: 35px auto 0 auto;
      animation: float-in 0.9s cubic-bezier(.5,0,.2,1);
      max-width: 380px;
    }
    .draft-notes {
      background: #f3f4f6;
      border-radius: 8px;
      padding: 7px 13px;
      font-size: 0.97em;
      color: #52525b;
      margin-bottom: 8px;
      margin-top: 2px;
      min-height: 1.3em;
    }
    .draft-edit-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .edit-btn {
      background: #fff;
      border: 1.3px solid var(--secondary);
      color: var(--secondary);
      padding: 7px 12px;
      border-radius: 6px;
      font-size: 0.97em;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.12s, color 0.12s, border 0.12s;
      margin-left: 2px;
    }
    .edit-btn:hover,
    .edit-btn:focus {
      background: var(--secondary);
      color: #fff;
      border-color: var(--primary);
    }
    .save-btn {
      background: var(--secondary);
      border: none;
      color: #fff;
      padding: 8px 15px;
      border-radius: 6px;
      font-size: 0.97em;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.13s;
    }
    .save-btn:hover,
    .save-btn:focus {
      background: var(--primary);
    }
    .draft-item.editing {
      background: #e0f2fe;
      box-shadow: 0 8px 32px #7c3aed13;
      border-color: #38bdf8;
    }
    .draft-item.editing .draft-title { color: #0ea5e9;}
    /* Responsive */
    @media (max-width: 950px) {
      .drafts-container { max-width: 99vw; }
      .header-bar, .draft-list { padding-left: 3vw; padding-right: 3vw; }
      .draft-item { max-width: 96vw;}
    }
    @media (max-width: 650px) {
      .drafts-container { border-radius: 0; }
      .header-bar { padding: 24px 2vw 16px 2vw;}
      .header-bar h2 { font-size: 1.1em;}
      .draft-list { padding: 16px 1vw 0 1vw;}
      .draft-item { padding: 10px 3vw 10px 10px; }
      .draft-title { font-size: 1em;}
    }
    @media (max-width: 400px) {
      .draft-item { padding: 7px 2vw 7px 7px; }
    }
    /* Button ripple effect */
    .ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple 520ms linear;
      background-color: rgba(124,58,237,0.25);
      pointer-events: none;
      z-index: 2;
    }
    @keyframes ripple {
      to {
        transform: scale(2.1);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div class="drafts-container">
    <div class="header-bar">
      <h2>📄 Your Saved Drafts</h2>
      <div class="header-actions">
        <button class="header-btn" onclick="window.location.href='texteditor.html'" id="editorBtn">
          <span class="icon">📝</span>Back to Editor
        </button>
        <button class="header-btn" onclick="window.location.href='index.html'" id="dashboardBtn">
          <span class="icon">🏠</span>Back to Dashboard
        </button>
      </div>
      <div class="search-bar-container">
        <input type="text" class="search-bar" id="searchBar" placeholder="Search drafts by title or notes..." autocomplete="off">
      </div>
    </div>
    <ul class="draft-list" id="draftList"></ul>
  </div>
  <script>
    const icons = {
      open: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" width="21" height="21" viewBox="0 0 20 20"><path stroke="#fff" stroke-width="2" d="M5 10.5l4 4 6-7"/></svg>`,
      delete: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" width="19" height="19" viewBox="0 0 20 20"><rect x="5" y="9" width="10" height="2" rx="1" fill="#fff"/><rect x="9" y="5" width="2" height="10" rx="1" fill="#fff"/></svg>`,
      document: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" width="19" height="19" viewBox="0 0 20 20"><rect x="4" y="3" width="12" height="14" rx="3" stroke="#7c3aed" stroke-width="1.7" fill="#fff"/><rect x="6" y="7" width="8" height="2" rx="1" fill="#7c3aed"/></svg>`,
      edit: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" width="17" height="17" viewBox="0 0 20 20"><path stroke="#10b981" stroke-width="2" d="M13.5 4.5l2 2m-1 1l-8 8H4.5v-2l8-8z"/></svg>`,
      save: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" width="19" height="19" viewBox="0 0 20 20"><rect x="4" y="4" width="12" height="12" rx="3" stroke="#10b981" stroke-width="1.7" fill="#fff"/><path d="M8 11.5l1.5 1.5 3-4" stroke="#10b981" stroke-width="1.7" fill="none"/></svg>`
    };

    const draftsKey = "taskflows_drafts";
    function getDrafts() { return JSON.parse(localStorage.getItem(draftsKey) || "[]"); }
    function setDrafts(drafts) { localStorage.setItem(draftsKey, JSON.stringify(drafts)); }
    function formatDate(str) {
      if (!str) return "";
      const d = new Date(str);
      return d.toLocaleString(undefined, {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    // Save notes and editing state in-memory for this session
    let editingDraftId = null;
    let editingNoteValue = "";

    function renderDrafts(search = "") {
      const drafts = getDrafts();
      const list = document.getElementById('draftList');
      list.innerHTML = "";
      // Filter by search string (title or notes)
      const searchLower = search.trim().toLowerCase();
      let filteredDrafts = drafts;
      if(searchLower) {
        filteredDrafts = drafts.filter(d =>
          (d.title && d.title.toLowerCase().includes(searchLower)) ||
          (d.notes && d.notes.toLowerCase().includes(searchLower))
        );
      }
      if (filteredDrafts.length === 0) {
        list.innerHTML = `<li class="empty-message">No drafts found.<br>Try a different search or start a new draft in <b>Editor</b>!</li>`;
        return;
      }
      filteredDrafts.slice().reverse().forEach(draft => {
        const li = document.createElement('li');
        li.className = "draft-item";
        li.tabIndex = 0;
        li.setAttribute("role","group");

        // --- Inline notes editing feature ---
        let notesSection = "";
        if(editingDraftId === draft.id) {
          // Editing notes
          notesSection = `
            <div class="draft-edit-bar">
              <input type="text" class="draft-notes" id="noteInput_${draft.id}" value="${draft.notes ? draft.notes.replace(/"/g, "&quot;") : ""}" style="flex:1;">
              <button class="save-btn" onclick="saveNote('${draft.id}', event)">${icons.save} Save</button>
            </div>
          `;
        } else {
          notesSection = `
            <div class="draft-notes" ondblclick="editNote('${draft.id}')">
              ${draft.notes ? draft.notes.replace(/</g,"&lt;") : '<span style="color:#bbb;">Double-click to add notes...</span>'}
              <button class="edit-btn" onclick="editNote('${draft.id}', event)" title="Edit notes">${icons.edit}Edit</button>
            </div>
          `;
        }
        // ---

        li.innerHTML = `
          <div class="draft-title">
            <span class="icon">${icons.document}</span> 
            ${draft.title ? draft.title.replace(/</g,"&lt;") : "Untitled"}
          </div>
          <span class="draft-date">${formatDate(draft.updated)}</span>
          ${notesSection}
          <div class="draft-actions">
            <button class="open-btn" data-draft-id="${draft.id}" title="Open in Editor" type="button">${icons.open} Open</button>
            <button class="delete-btn" onclick="deleteDraft('${draft.id}', event)" title="Delete draft" type="button">${icons.delete} Delete</button>
          </div>
        `;
        li.onclick = (e) => {
          // Only trigger open if NOT clicking on a button and NOT editing
          if(!e.target.closest('button') && editingDraftId === null) loadDraft(draft.id, e)
        };
        if(editingDraftId === draft.id) li.classList.add("editing");
        list.appendChild(li);
      });

      // Make sure all open buttons work:
      document.querySelectorAll('.open-btn').forEach(btn => {
        // Remove any previous event listeners by cloning the node
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.addEventListener("click", function(e) {
          e.stopPropagation();
          loadDraft(this.getAttribute('data-draft-id'), e);
        });
      });
    }

    function loadDraft(id, e) {
      if (e) ripple(e);
      // Store the selected draft id in sessionStorage to communicate to the editor
      sessionStorage.setItem('selectedDraftId', id);
      window.location.href = `texteditor.html?draft=${encodeURIComponent(id)}`;
    }
    function deleteDraft(id, e) {
      if (e) ripple(e, "red");
      setTimeout(()=>{
        if (!confirm("Delete this draft?")) return;
        let drafts = getDrafts();
        drafts = drafts.filter(d => d.id !== id);
        setDrafts(drafts);
        if(editingDraftId===id) editingDraftId = null;
        renderDrafts(document.getElementById('searchBar').value);
      }, 100);
    }

    // --- Inline notes editing ---
    function editNote(id, e) {
      if(e) e.stopPropagation();
      editingDraftId = id;
      setTimeout(()=>{
        const input = document.getElementById("noteInput_"+id);
        if(input) input.focus();
      }, 0);
      renderDrafts(document.getElementById('searchBar').value);
    }
    function saveNote(id, e) {
      if(e) e.stopPropagation();
      const input = document.getElementById("noteInput_"+id);
      const value = input.value;
      let drafts = getDrafts();
      let idx = drafts.findIndex(d=>d.id===id);
      if(idx > -1) {
        drafts[idx].notes = value;
        setDrafts(drafts);
      }
      editingDraftId = null;
      renderDrafts(document.getElementById('searchBar').value);
    }
    window.editNote = editNote;
    window.saveNote = saveNote;
    window.loadDraft = loadDraft;
    window.deleteDraft = deleteDraft;

    // Ripple effect
    function ripple(e, color) {
      const button = e.currentTarget || e.target;
      if(!button) return;
      const circle = document.createElement("span");
      circle.classList.add("ripple");
      if (color === "red") circle.style.background = "rgba(239,68,68,0.16)";
      const rect = button.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      circle.style.width = circle.style.height = size + "px";
      circle.style.left = (e.clientX - rect.left - size / 2) + "px";
      circle.style.top = (e.clientY - rect.top - size / 2) + "px";
      button.appendChild(circle);
      setTimeout(() => circle.remove(), 520);
    }

    // Keyboard accessibility: Escape to cancel edit, Enter to save, arrows to move
    document.addEventListener('keydown', function(e){
      if(editingDraftId){
        if(e.key==="Escape"){
          editingDraftId = null;
          renderDrafts(document.getElementById('searchBar').value);
        } else if(e.key==="Enter"){
          const input = document.getElementById("noteInput_"+editingDraftId);
          if(input && document.activeElement === input) {
            saveNote(editingDraftId, e);
          }
        }
      }
    });

    // Search bar live filter
    document.getElementById('searchBar').addEventListener('input', function(){
      renderDrafts(this.value);
    });

    // Touch feedback for mobile
    document.addEventListener('touchstart', e => {
      if (e.target.tagName === 'BUTTON') e.target.classList.add('pressed');
    }, {passive:true});
    document.addEventListener('touchend', e => {
      if (e.target.tagName === 'BUTTON') e.target.classList.remove('pressed');
    }, {passive:true});

    renderDrafts();

    // Focus first element for accessibility
    setTimeout(()=>{
      let first = document.querySelector('.draft-item');
      if(first) first.focus();
    }, 200);

  </script>
</body>
</html>
